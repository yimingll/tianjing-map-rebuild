# 架构文档

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   Steam Client (Electron)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   React UI   │  │  Game Store  │  │ Socket.IO    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
                            │ WebSocket
                            │
┌─────────────────────────────────────────────────────────┐
│                    Game Server (NestJS)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  WebSocket   │  │   REST API   │  │  Game Logic  │  │
│  │   Gateway    │  │ Controllers  │  │   Services   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
    ┌───────────▼──────────┐  ┌────────▼─────────┐
    │   PostgreSQL DB      │  │   Redis Cache    │
    │  - Player Data       │  │  - Sessions      │
    │  - World State       │  │  - Real-time     │
    │  - Transactions      │  │  - Leaderboards  │
    └──────────────────────┘  └──────────────────┘
```

## 模块设计

### 1. 共享模块 (Shared)

**职责**: 定义前后端共享的类型、接口和常量

**核心组件**:
- 类型定义 (Player, World, Combat, Economy)
- 事件定义 (SocketEvent)
- 游戏常量 (GAME_CONFIG, ERROR_CODES)

### 2. 服务器模块 (Server)

#### 2.1 认证模块 (Auth)
- 用户注册和登录
- 密码加密 (bcrypt)
- 会话管理

#### 2.2 玩家模块 (Player)
- 玩家数据管理
- 状态更新
- 经验值和等级系统
- 属性系统

#### 2.3 世界模块 (World)
- 房间管理
- 地图系统
- 玩家位置追踪
- 区域管理

#### 2.4 战斗模块 (Combat)
- 战斗状态管理
- 回合制战斗逻辑
- 伤害计算
- 效果系统

#### 2.5 经济模块 (Economy)
- 货币系统
- 交易管理
- 商店系统
- 防作弊事务处理

#### 2.6 聊天模块 (Chat)
- 全局聊天
- 房间聊天
- 私聊
- 系统消息

#### 2.7 游戏网关 (Game)
- WebSocket 连接管理
- 玩家加入/离开
- 移动处理
- 实时事件分发

### 3. 客户端模块 (Client)

#### 3.1 Electron 主进程
- 窗口管理
- Steam API 集成（待实现）
- 系统托盘
- 自动更新

#### 3.2 React 应用
- **组件层**:
  - Login: 登录/注册界面
  - GameView: 游戏主界面
  - 其他UI组件（待扩展）

- **状态管理 (Zustand)**:
  - 游戏状态
  - 玩家数据
  - 房间信息
  - 聊天消息

- **网络层**:
  - Socket.IO 客户端
  - 事件监听和发送
  - 断线重连

## 数据流

### 1. 玩家登录流程

```
Client                Server              Database
  │                     │                     │
  │─── POST /auth/login ──>                   │
  │                     │                     │
  │                     │─── Query Player ──> │
  │                     │ <── Player Data ─── │
  │                     │                     │
  │ <─── Player Data ───│                     │
  │                     │                     │
  │─── Socket Auth ────>│                     │
  │                     │                     │
  │ <── Auth Success ───│                     │
  │ <── Room Data ──────│                     │
```

### 2. 玩家移动流程

```
Client                Server              WorldService
  │                     │                     │
  │─── PLAYER_MOVE ───> │                     │
  │      (direction)    │                     │
  │                     │─── Validate Move ──>│
  │                     │ <── New Room ───────│
  │                     │                     │
  │                     │─── Update Position ─┤
  │                     │                     │
  │ <── ROOM_ENTER ─────│                     │
  │     (new room)      │                     │
```

### 3. 战斗流程

```
Client                CombatService       PlayerService
  │                     │                     │
  │─── COMBAT_ACTION ──>│                     │
  │                     │                     │
  │                     │─── Calculate ───────>
  │                     │     Damage          │
  │                     │                     │
  │                     │ <── Update Health ──│
  │                     │                     │
  │ <── COMBAT_RESULT ──│                     │
  │                     │                     │
```

## 扩展性设计

### 1. 微服务架构（未来）

当玩家数量增长时，可以拆分为多个服务：

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Gateway   │  │   Combat    │  │    Chat     │
│   Service   │  │   Service   │  │   Service   │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┴────────────────┘
                        │
                  ┌─────▼─────┐
                  │  Message  │
                  │   Queue   │
                  │ (RabbitMQ)│
                  └───────────┘
```

### 2. 负载均衡

```
            ┌─────────────┐
            │   Nginx     │
            │Load Balancer│
            └─────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
   ┌────▼───┐ ┌───▼────┐ ┌───▼────┐
   │Server 1│ │Server 2│ │Server 3│
   └────────┘ └────────┘ └────────┘
        │          │          │
        └──────────┴──────────┘
                   │
            ┌──────▼──────┐
            │  PostgreSQL │
            │   Cluster   │
            └─────────────┘
```

### 3. MOD 系统架构

```
┌─────────────────────────────────────┐
│         Mod Loader (Server)         │
│  ┌─────────────┐  ┌─────────────┐  │
│  │  Lua/JS VM  │  │   Plugin    │  │
│  │  Sandbox    │  │   Manager   │  │
│  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────┘
                │
    ┌───────────┴───────────┐
    │                       │
┌───▼──────┐         ┌──────▼────┐
│  Events  │         │   Hooks   │
│  System  │         │  System   │
└──────────┘         └───────────┘
```

## 性能优化策略

### 1. 服务器端
- **Redis 缓存**: 缓存玩家在线状态、房间信息
- **数据库索引**: 为频繁查询的字段添加索引
- **连接池**: 复用数据库连接
- **事件驱动**: 使用 Socket.IO rooms 减少广播开销

### 2. 客户端
- **状态分片**: 只订阅当前房间的事件
- **消息限流**: 防止聊天刷屏
- **虚拟列表**: 优化大量消息渲染
- **本地缓存**: 缓存静态资源和配置

### 3. 网络优化
- **消息压缩**: 启用 Socket.IO 压缩
- **心跳机制**: 检测和处理断线
- **增量更新**: 只发送变化的数据

## 安全性设计

### 1. 认证和授权
- 密码使用 bcrypt 加密存储
- 会话管理使用 Redis
- 所有 WebSocket 连接需要认证

### 2. 防作弊
- 服务器权威：所有游戏逻辑在服务器端计算
- 输入验证：验证所有客户端输入
- 速率限制：防止刷屏和 API 滥用

### 3. 数据安全
- 使用事务保证数据一致性
- 定期备份数据库
- SQL 注入防护 (TypeORM)

## 可监控性

### 日志系统
- 应用日志 (Winston)
- 访问日志
- 错误追踪 (Sentry)

### 性能监控
- 服务器 CPU/内存监控
- 数据库查询性能
- WebSocket 连接数
- 平均响应时间

### 业务指标
- 在线玩家数
- 每日活跃用户 (DAU)
- 平均游戏时长
- 服务器负载
