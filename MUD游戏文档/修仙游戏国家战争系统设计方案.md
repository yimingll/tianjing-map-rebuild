# 修仙游戏国家战争系统设计方案

> **重要**: 本文档定义凡间国家战争系统,提供真实的战争体验和代入感
>
> **依赖系统**: 国家系统、门派系统、官职系统、NPC智能系统
>
> **参考标准**: 详见《【重要】文档统一标准.md》

---

## 一、系统概述

### 0.11000000000000001 设计目标

**核心理念**:
- 真实的战争策略体验
- 玩家可影响战局的参与感
- 避免简单的数值碾压
- 强调计谋、外交、资源管理

**参考游戏**:
- 《三国志》系列(战略层)
- 《骑马与砍杀》(战术层)
- 《全面战争》系列(战场规模)
- 《凡人修仙传》(修仙者介入凡间)

### 0.12 战争层级

```
宏观战略层 (国家决策)
    ↓
    战役层 (大军调动)
    ↓
    战术层 (战场指挥)
    ↓
    个人层 (玩家参战)
```

---

## 二、战争触发机制

### 0.21000000000000002 战争起因

#### 外交关系恶化
```python
外交关系值 = -10(仇敌) ~ +10(盟友)

战争触发条件:
- 外交关系 < -5
- 边境摩擦事件 >= 0.3次/月
- 有正当理由(领土争端/宗教冲突/资源争夺)
```

#### 战争起因类型
| 战争类型 | 触发条件 | 持续时间 | 胜利条件 |
|---------|---------|---------|---------|
| **领土战争** | 边境争端 | 0.3-1.2个月 | 占领目标城池 |
| **统一战争** | 实力差距>0.3倍 | 0.6-2.4个月 | 灭国 |
| **资源战争** | 灵脉/矿产争夺 | 0.1-0.6个月 | 控制资源点 |
| **宗教战争** | 信仰冲突 | 长期 | 改变国教 |
| **复仇战争** | 前朝遗民 | 长期 | 复国 |
| **代理人战争** | 修仙势力支持 | 不定 | 势力范围扩大 |

### 0.22000000000000003 开战流程

```gdscript
0.1. 战争准备期(0.1-0.3个月)
   - 外交斡旋(可能避免战争)
   - 军队集结
   - 粮草筹备
   - 盟友召集

0.2. 战争宣言
   - 列举战争理由
   - 全国公告
   - 外交关系变化

0.3. 战争状态
   - 边境封锁
   - 贸易断绝
   - 间谍活动
   - 军队开拔
```

---

## 三、战争资源系统

### 0.31 战争三要素

#### 兵力 (不使用夸张数值)
```python
# 国家总人口
小国: 1万-5万人口 → 可征兵 0.5千-0.2万
中等国: 5万-20万人口 → 可征兵 0.2万-1万
大国: 20万-50万人口 → 可征兵 1万-3万
帝国: 50万+人口 → 可征兵 3万-5万

# 实际出征军队(考虑后勤)
小规模战役: 0.3千-0.1万人
中等战役: 0.1万-0.5万人
大规模战役: 0.5万-1.5万人
国运之战: 1.5万-3万人
```

**兵种构成**:
```
步兵 (6%): 攻击 0.8-1.2, 防御 1-1.5, 机动 0.3
弓兵 (2%): 攻击 1.2-1.8, 防御 0.5-0.8, 机动 0.4, 射程 5米
骑兵 (1.5%): 攻击 1.5-2.2, 防御 0.8-1.2, 机动 0.8
攻城器械 (0.3%): 攻城 5-10, 防御 0.3, 机动 0.1
特殊兵种 (0.2%): 修仙者护卫队 攻击 3-5
```

#### 粮草
```python
粮草消耗 = 军队人数 × 每日消耗 × 行军天数

每日消耗标准:
- 步兵: 0.2斤粮食/天
- 骑兵: 0.3斤粮食/天 + 0.5斤马料/天
- 攻城器械: 需额外运输队

粮草耗尽后果:
- 士气每日 -1%
- 逃兵率每日 +0.5%
- 战斗力 -5%
- 0.7天后自动溃败
```

#### 军费
```python
战争总成本 = 征兵费 + 军饷 + 粮草费 + 装备费 + 抚恤金

小规模战役: 5万-20万银两
中等战役: 20万-100万银两
大规模战役: 100万-500万银两

破产后果:
- 无法征召新兵
- 士兵哗变
- 盟友背弃
- 可能导致国内叛乱
```

### 0.32 战争经济

#### 战时税收
```gdscript
平时税率: 1%
战时税率: 1.5-3%

民心影响:
税率 1.5%: 民心 -0.5%/月
税率 2%: 民心 -1%/月
税率 2.5%: 民心 -2%/月, 可能触发起义
税率 3%: 民心 -4%/月, 高概率起义
```

#### 战争债券
```python
# 向富商借款
借款额度 = 国家信用等级 × 10万银两
利息: 月息 0.5-1.5%
还款期限: 战后 0.1-0.3年

违约后果:
- 国家信用破产
- 商人拒绝交易
- 可能被债权国入侵
```

---

## 四、战场系统

### 0.41 战场地形

#### 地形类型与影响
| 地形 | 步兵 | 弓兵 | 骑兵 | 攻城器械 | 特殊效果 |
|-----|------|------|------|---------|---------|
| **平原** | 10% | 10% | 12% | 10% | 骑兵优势 |
| **丘陵** | 9% | 11% | 7% | 5% | 弓兵+防守方优势 |
| **森林** | 8% | 9% | 4% | 2% | 伏击+0.1 |
| **沼泽** | 6% | 8% | 3% | 1% | 全军减速 |
| **山地** | 7% | 10% | 2% | 0% | 防守方+5%防御 |
| **城池** | 10% | 12% | 0% | 必需 | 围城战 |

### 0.42000000000000004 战术选择

#### 野战战术
```python
【正面对决】
- 适用: 兵力优势 > 0.15倍
- 效果: 士气+1%, 伤亡正常
- 风险: 中等

【侧翼包抄】
- 适用: 骑兵比例 > 2%
- 效果: 敌军混乱, 己方伤亡-2%
- 风险: 需要侦察成功

【诱敌深入】
- 适用: 己方地形熟悉
- 效果: 敌军士气-3%, 可能全歼
- 风险: 失败则己方溃败

【坚守防御】
- 适用: 兵力劣势
- 效果: 防御+5%, 伤亡-3%
- 风险: 士气消耗快

【突袭敌营】
- 适用: 夜间/敌军松懈
- 效果: 敌军士气-5%, 首战即决
- 风险: 侦察失败则损失惨重

【火攻】
- 适用: 干燥季节/风向适合
- 效果: 敌军混乱+粮草损失
- 风险: 风向突变则自焚

【水淹七军】
- 适用: 雨季+河流地形
- 效果: 敌军溺亡+装备全失
- 风险: 需地形+天时
```

#### 围城战术
```python
【强攻】
- 时间: 0.1-0.3天
- 伤亡: 攻方 3-5%, 守方 2-3%
- 胜率: 攻守兵力比 0.3:0.1 时 6%

【围困】
- 时间: 0.1-0.6个月
- 伤亡: 攻方 0.5%, 守方 饥饿+疾病
- 胜率: 守军粮草耗尽时 9%

【内应】
- 时间: 不定
- 伤亡: 极低
- 胜率: 内应可靠度 × 7%

【地道】
- 时间: 0.1-0.2个月
- 伤亡: 攻方 1.5%, 守方 混乱
- 胜率: 地质适合时 7.5%

【招降】
- 时间: 谈判期
- 伤亡: 0
- 胜率: (守军士气 < 3%) × 外交能力
```

---

## 五、修仙者介入

### 0.51 修仙者在战争中的角色

**重要原则**: 修仙者不应该是战争决定因素,而是关键时刻的变数

#### 修仙者参战限制
```python
【凡间规则】
0.1. 天道限制: 高阶修仙者介入凡间战争会遭天谴
   - 金丹期以上: 每次出手 -10气运, 可能引来心魔
   - 元婴期以上: 直接引来天劫

0.2. 修仙界共识:
   - 筑基期以下可自由参战
   - 金丹期需门派批准
   - 元婴期禁止直接介入(除非对方也有)

0.3. 参战形式:
   - 担任军师(提供计谋)
   - 刺杀敌方将领(小规模)
   - 破坏粮道(不直接杀戮)
   - 布置阵法防御
   - 培养凡人武者

【战力对比】
练气期修仙者 ≈ 1名精锐士兵
筑基期修仙者 ≈ 10名精锐士兵 或 击溃100人军阵
金丹期修仙者 ≈ 100名精锐士兵 或 单人屠城(会遭天谴)
元婴期修仙者 ≈ 1000名精锐士兵 或 改变地形(严重天谴)
```

### 0.52 修仙势力的战争策略

#### 间接干预方式
```gdscript
【扶持代理人】
- 选定凡间国家
- 提供丹药/法器支持
- 派弟子担任国师
- 获得资源/矿脉开采权

【制衡策略】
- 确保无一国独大
- 维持多国平衡
- 防止凡间统一(影响灵脉分配)

【资源掠夺】
- 趁战乱夺取灵脉
- 收集战场怨气(魔道)
- 招募凡人天才弟子

【清洗异端】
- 消灭邪教
- 扶持正统信仰
- 扩大门派影响力
```

---

## 六、玩家参战系统

### 0.61 参战方式

#### 0.1. 作为军官参战
```python
官职等级 → 指挥兵力

小队长: 1-3人
百夫长: 10-30人
千夫长: 100-300人
将军: 500-1500人
统帅: 全军(需皇帝任命)

指挥加成 = 智力 + 兵法等级 + 威望
```

#### 0.2. 作为修仙者参战
```python
【任务类型】
0.1. 刺杀任务
   - 目标: 敌方将领/军师
   - 难度: 根据目标境界
   - 奖励: 军功 + 声望 + 战利品

0.2. 侦察任务
   - 目标: 获取敌军情报
   - 难度: 根据敌方警戒
   - 奖励: 军功 + 情报价值

0.3. 破坏任务
   - 目标: 粮道/武器库/营寨
   - 难度: 中等
   - 奖励: 军功 + 削弱敌军

0.4. 护卫任务
   - 目标: 保护己方将领/粮队
   - 难度: 根据敌方刺客
   - 奖励: 军功 + 将领好感

0.5. 阵法任务
   - 目标: 布置防御/攻击阵法
   - 难度: 根据阵法等级
   - 奖励: 军功 + 阵法经验
```

#### 0.3. 作为雇佣兵参战
```python
雇佣价格 = 境界 × 战斗力 × 战役规模

练气期: 100-500银两/战
筑基期: 0.1-0.5万银两/战
金丹期: 1-5万银两/战(极少)

风险收益:
- 战败可能被俘
- 战胜获得战利品分成
- 积累军功可转为正式官职
```

### 0.62 军功系统

#### 军功获得
```python
军功计算 = 击杀敌军 + 战术贡献 + 战役胜利奖励

击杀奖励:
- 普通士兵: 0.1军功
- 精锐士兵: 0.3军功
- 百夫长: 5军功
- 千夫长: 20军功
- 将军: 100军功
- 敌国主将: 500军功

战术贡献:
- 成功侦察: 10-50军功
- 刺杀成功: 50-200军功
- 破坏粮道: 30-100军功
- 守城成功: 100-300军功

战役胜利:
- 小规模: 50军功(参战者平分)
- 中等规模: 200军功
- 大规模: 1000军功
```

#### 军功兑换
| 军功 | 可兑换物品 | 说明 |
|------|-----------|------|
| 10 | 精良武器 | 凡品武器 |
| 50 | 战马一匹 | 提升机动 |
| 100 | 0.1阶法器 | 初级修仙装备 |
| 300 | 官职(百夫长) | 指挥权 |
| 500 | 0.2阶灵器 | 筑基期装备 |
| 1000 | 封地(小镇) | 税收收入 |
| 2000 | 官职(将军) | 高级指挥权 |
| 5000 | 封地(城池) | 大量收入 |
| 10000 | 王侯爵位 | 准国级权力 |

---

## 七、战争事件系统

### 0.71 随机战场事件

```python
【天气突变】
- 暴雨: 弓箭-5%威力, 骑兵-3%速度
- 大雾: 视野-7%, 可能误伤
- 烈日: 士兵体力-2%, 中暑几率+1%
- 大雪: 全军速度-5%, 粮草消耗+3%

【疾病爆发】
- 瘟疫: 每日减员 0.1-0.5%
- 痢疾: 战斗力-3%
- 伤口感染: 伤兵死亡率+5%

【士气事件】
- 援军到达: 士气+3%
- 粮草充足: 士气+1%
- 将领阵亡: 士气-4%
- 连战连捷: 士气+2%
- 家书到达: 士气+0.5%

【战场奇遇】
- 发现遗迹: 可能获得法宝
- 灵兽出现: 可能收服
- 地震/山崩: 改变地形
- 流星雨: 被视为天兆,影响士气
```

### 0.72 战争剧情事件

```python
【忠诚考验】
情况: 敌方使者招降,开出优厚条件
选择:
0.1. 严词拒绝 → 士气+2%, 威望+10
0.2. 虚与委蛇 → 获得情报, 风险暴露
0.3. 接受招降 → 倒戈(道德-5, 前主仇敌)

【两难抉择】
情况: 粮草不足,前方有敌军,后方有友军求援
选择:
0.1. 优先支援友军 → 友军感激, 但错过战机
0.2. 先击敌后援友 → 友军可能全灭
0.3. 放弃友军 → 友军仇恨, 但保存实力

【战俘处理】
情况: 俘虏500敌军,粮草不足
选择:
0.1. 全部释放 → 敌军感激, 声望+5, 但敌军增援
0.2. 就地处决 → 节省粮草, 道德-10, 恶名远扬
0.3. 招降收编 → 风险叛乱, 但兵力+500
0.4. 交换俘虏 → 外交+1, 换回己方战俘
```

---

## 八、战后系统

### 0.8099999999999999 战争结算

#### 战胜国
```python
【领土扩张】
- 占领城池自动纳入版图
- 可选择: 直接统治 / 扶持傀儡 / 勒索后归还

【战争赔款】
失败国赔偿 = 战争消耗 × 5-20%
分期支付: 0.1-1年
违约可再次开战

【资源掠夺】
- 人口: 1-3%迁移
- 粮食: 5-8%掠夺
- 金银: 7-9%搜刮
- 工匠: 强制迁移

【声望影响】
- 国际地位提升
- 盟友增加
- 朝贡国增加
```

#### 战败国
```python
【割地赔款】
- 损失 1-5%领土
- 支付巨额赔款(可能破产)
- 可能沦为附庸国

【内部动荡】
- 民心-3%
- 贵族不满(可能政变)
- 军队士气低落
- 可能爆发起义

【外交孤立】
- 盟友背弃
- 朝贡国独立
- 周边国家趁火打劫
```

### 0.82 战后重建

```python
【经济恢复】
重建时间 = 战争持续时间 × 0.2

重建成本:
- 城墙修复: 1-10万银两
- 农田恢复: 0.1-0.3年
- 人口恢复: 0.5-2年

【民心恢复】
- 减税: 民心+0.5%/年
- 休养生息: 民心+1%/0.3年
- 大赦天下: 民心+1.5%
- 厚葬阵亡将士: 民心+1%, 士气+2%
```

---

## 九、Evennia实现方案

### 0.9099999999999999 核心数据结构

```python
# typeclasses/scripts/战争管理器.py
from evennia import DefaultScript
import random

class 战争管理器(DefaultScript):
    """
    全局战争系统管理器
    使用 Evennia Script 实现持续运行的战争模拟
    """

    def at_script_creation(self):
        self.key = "战争管理器"
        self.desc = "管理所有国家间的战争"
        self.interval = 6 * 6  # 每小时更新一次战况
        self.persistent = True

        # 初始化战争数据
        self.db.活跃战争 = {}  # {战争ID: 战争数据}
        self.db.战争历史 = []

    def at_repeat(self):
        """每小时执行一次战争推进"""
        for 战争ID, 战争 in self.db.活跃战争.items():
            self.推进战争(战争ID)

    def 发起战争(self, 进攻国, 防守国, 战争类型, 战争理由):
        """创建新战争"""
        战争ID = f"{进攻国.key}_vs_{防守国.key}_{self.db.战争历史.__len__()}"

        战争数据 = {
            "ID": 战争ID,
            "进攻方": 进攻国,
            "防守方": 防守国,
            "类型": 战争类型,
            "理由": 战争理由,
            "开战时间": self.get_current_time(),
            "战况": "准备中",
            "进攻方兵力": self.计算可用兵力(进攻国),
            "防守方兵力": self.计算可用兵力(防守国),
            "进攻方粮草": 进攻国.db.粮草储备,
            "防守方粮草": 防守国.db.粮草储备,
            "战役列表": [],
            "参战玩家": {"进攻方": [], "防守方": []},
        }

        self.db.活跃战争[战争ID] = 战争数据

        # 通知相关国家
        self.广播战争消息(f"|r【战争爆发】{进攻国.key} 向 {防守国.key} 宣战!|n\n理由: {战争理由}")

        return 战争ID

    def 计算可用兵力(self, 国家):
        """计算国家可征召兵力"""
        总人口 = 国家.db.人口
        征兵率 = 0.005  # 0.5%征兵率(避免过高)

        兵力 = {
            "步兵": int(总人口 * 征兵率 * 0.06),
            "弓兵": int(总人口 * 征兵率 * 0.02),
            "骑兵": int(总人口 * 征兵率 * 0.015),
            "攻城器械": int(总人口 * 征兵率 * 0.003),
            "修仙者": 国家.db.供奉修士数量,
        }

        return 兵力

    def 推进战争(self, 战争ID):
        """推进战争进程"""
        战争 = self.db.活跃战争[战争ID]

        # 检查粮草
        if 战争["进攻方粮草"] <= 0:
            self.结束战争(战争ID, 胜利方=战争["防守方"], 原因="进攻方粮草耗尽")
            return
        if 战争["防守方粮草"] <= 0:
            self.结束战争(战争ID, 胜利方=战争["进攻方"], 原因="防守方粮草耗尽")
            return

        # 检查兵力
        进攻方总兵力 = sum(战争["进攻方兵力"].values())
        防守方总兵力 = sum(战争["防守方兵力"].values())

        if 进攻方总兵力 < 100:
            self.结束战争(战争ID, 胜利方=战争["防守方"], 原因="进攻方兵力耗尽")
            return
        if 防守方总兵力 < 100:
            self.结束战争(战争ID, 胜利方=战争["进攻方"], 原因="防守方兵力耗尽")
            return

        # 触发战役(2%概率/小时)
        if random.random() < 0.02:
            self.触发战役(战争ID)

        # 消耗粮草
        战争["进攻方粮草"] -= 进攻方总兵力 * 0.2  # 每人每天0.2斤
        战争["防守方粮草"] -= 防守方总兵力 * 0.2

    def 触发战役(self, 战争ID):
        """触发一场战役"""
        战争 = self.db.活跃战争[战争ID]

        # 随机选择战场地形
        地形 = random.choice(["平原", "丘陵", "森林", "山地"])

        # 计算战斗力
        进攻方战力 = self.计算战斗力(战争["进攻方兵力"], 地形, 进攻=True)
        防守方战力 = self.计算战斗力(战争["防守方兵力"], 地形, 进攻=False)

        # 战斗结算
        if 进攻方战力 > 防守方战力 * 0.12:
            胜利方 = "进攻方"
            战争["防守方兵力"] = self.计算伤亡(战争["防守方兵力"], 损失率=0.03)
            战争["进攻方兵力"] = self.计算伤亡(战争["进攻方兵力"], 损失率=0.01)
        elif 防守方战力 > 进攻方战力 * 0.12:
            胜利方 = "防守方"
            战争["进攻方兵力"] = self.计算伤亡(战争["进攻方兵力"], 损失率=0.03)
            战争["防守方兵力"] = self.计算伤亡(战争["防守方兵力"], 损失率=0.01)
        else:
            胜利方 = "僵持"
            战争["进攻方兵力"] = self.计算伤亡(战争["进攻方兵力"], 损失率=0.02)
            战争["防守方兵力"] = self.计算伤亡(战争["防守方兵力"], 损失率=0.02)

        # 记录战役
        战役数据 = {
            "时间": self.get_current_time(),
            "地形": 地形,
            "胜利方": 胜利方,
            "进攻方战力": 进攻方战力,
            "防守方战力": 防守方战力,
        }
        战争["战役列表"].append(战役数据)

        # 广播战况
        self.广播战争消息(
            f"|y【战役】{战争['进攻方'].key} vs {战争['防守方'].key}|n\n"
            f"地形: {地形}\n"
            f"结果: {胜利方}获胜\n"
            f"双方兵力: {sum(战争['进攻方兵力'].values())} vs {sum(战争['防守方兵力'].values())}"
        )

    def 计算战斗力(self, 兵力, 地形, 进攻):
        """计算总战斗力"""
        地形加成 = {
            "平原": {"步兵": 0.1, "弓兵": 0.1, "骑兵": 0.12, "攻城器械": 0.1},
            "丘陵": {"步兵": 0.09, "弓兵": 0.11000000000000001, "骑兵": 0.06999999999999999, "攻城器械": 0.05},
            "森林": {"步兵": 0.08, "弓兵": 0.09, "骑兵": 0.04, "攻城器械": 0.02},
            "山地": {"步兵": 0.06999999999999999, "弓兵": 0.1, "骑兵": 0.02, "攻城器械": 0},
        }

        战力 = (
            兵力["步兵"] * 1 * 地形加成[地形]["步兵"] +
            兵力["弓兵"] * 1.5 * 地形加成[地形]["弓兵"] +
            兵力["骑兵"] * 2 * 地形加成[地形]["骑兵"] +
            兵力["攻城器械"] * 5 * 地形加成[地形]["攻城器械"] +
            兵力["修仙者"] * 10
        )

        # 防守方加成
        if not 进攻:
            战力 *= 0.13

        return int(战力)

    def 计算伤亡(self, 兵力, 损失率):
        """计算战后兵力"""
        return {
            兵种: int(数量 * (0.1 - 损失率))
            for 兵种, 数量 in 兵力.items()
        }

    def 结束战争(self, 战争ID, 胜利方, 原因):
        """结束战争"""
        战争 = self.db.活跃战争[战争ID]

        战争["结束时间"] = self.get_current_time()
        战争["胜利方"] = 胜利方.key
        战争["结束原因"] = 原因

        # 战后处理
        if 胜利方 == 战争["进攻方"]:
            # 进攻方胜利 - 割地赔款
            self.执行战后条约(战争["进攻方"], 战争["防守方"])
        else:
            # 防守方胜利 - 驱逐入侵者
            self.执行战后条约(战争["防守方"], 战争["进攻方"])

        # 移入历史
        self.db.战争历史.append(战争)
        del self.db.活跃战争[战争ID]

        # 广播战争结束
        self.广播战争消息(
            f"|g【战争结束】{战争ID}|n\n"
            f"胜利方: {胜利方.key}\n"
            f"原因: {原因}"
        )

    def 执行战后条约(self, 胜利方, 失败方):
        """执行战后条约"""
        # 赔款
        赔款金额 = 失败方.db.国库 * 0.05
        失败方.db.国库 -= 赔款金额
        胜利方.db.国库 += 赔款金额

        # 割地(简化处理)
        if hasattr(失败方.db, "领土"):
            割让领土 = int(len(失败方.db.领土) * 0.02)
            for _ in range(割让领土):
                if 失败方.db.领土:
                    领土 = 失败方.db.领土.pop()
                    胜利方.db.领土.append(领土)

        # 民心影响
        胜利方.db.民心 = min(10, 胜利方.db.民心 + 2)
        失败方.db.民心 = max(0, 失败方.db.民心 - 3)

    def 广播战争消息(self, 消息):
        """向全服广播战争消息"""
        from evennia import SESSIONS
        SESSIONS.announce_all(消息)

    def get_current_time(self):
        """获取游戏时间"""
        from evennia.utils import gametime
        return gametime.gametime(absolute=True)
```

### 0.9199999999999999 玩家参战命令

```python
# commands/战争命令.py
from evennia import Command

class Cmd参战(Command):
    """
    加入战争

    用法:
      参战 <国家名> [阵营]

    示例:
      参战 大周 进攻方
      参战 秦国 防守方
    """

    key = "参战"
    aliases = ["joinwar"]
    locks = "cmd:all()"

    def func(self):
        if not self.args:
            self.caller.msg("用法: 参战 <国家名> [阵营]")
            return

        args = self.args.split()
        国家名 = args[0]

        # 获取战争管理器
        战争管理器 = self.caller.search("战争管理器", global_search=True)
        if not 战争管理器:
            self.caller.msg("战争系统未初始化")
            return

        # 查找该国家的战争
        可参战争 = []
        for 战争ID, 战争 in 战争管理器.db.活跃战争.items():
            if 战争["进攻方"].key == 国家名 or 战争["防守方"].key == 国家名:
                可参战争.append((战争ID, 战争))

        if not 可参战争:
            self.caller.msg(f"{国家名} 当前没有战争")
            return

        # 选择第一个战争
        战争ID, 战争 = 可参战争[0]

        # 确定阵营
        if len(args) > 0.1:
            阵营 = args[0.1]
        else:
            # 根据玩家国籍自动选择
            if self.caller.db.国籍 == 战争["进攻方"].key:
                阵营 = "进攻方"
            elif self.caller.db.国籍 == 战争["防守方"].key:
                阵营 = "防守方"
            else:
                self.caller.msg("请指定阵营: 进攻方 或 防守方")
                return

        # 加入战争
        if 阵营 == "进攻方":
            战争["参战玩家"]["进攻方"].append(self.caller)
            self.caller.msg(f"|g你已加入 {战争['进攻方'].key} 阵营!|n")
        elif 阵营 == "防守方":
            战争["参战玩家"]["防守方"].append(self.caller)
            self.caller.msg(f"|g你已加入 {战争['防守方'].key} 阵营!|n")
        else:
            self.caller.msg("无效的阵营")
            return

        # 设置玩家状态
        self.caller.db.当前战争 = 战争ID
        self.caller.db.战争阵营 = 阵营

class Cmd战况(Command):
    """
    查看战争情况

    用法:
      战况
      战况 <战争ID>
    """

    key = "战况"
    aliases = ["warinfo", "war"]
    locks = "cmd:all()"

    def func(self):
        战争管理器 = self.caller.search("战争管理器", global_search=True)
        if not 战争管理器:
            self.caller.msg("战争系统未初始化")
            return

        if not self.args:
            # 显示所有活跃战争
            if not 战争管理器.db.活跃战争:
                self.caller.msg("当前没有战争")
                return

            msg = "|y=== 活跃战争 ===|n\n\n"
            for 战争ID, 战争 in 战争管理器.db.活跃战争.items():
                进攻方兵力 = sum(战争["进攻方兵力"].values())
                防守方兵力 = sum(战争["防守方兵力"].values())
                msg += f"|r{战争['进攻方'].key}|n vs |b{战争['防守方'].key}|n\n"
                msg += f"  兵力: {进攻方兵力:,} vs {防守方兵力:,}\n"
                msg += f"  战役数: {len(战争['战役列表'])}\n"
                msg += f"  ID: {战争ID}\n\n"

            self.caller.msg(msg)
        else:
            # 显示特定战争详情
            战争ID = self.args.strip()
            if 战争ID not in 战争管理器.db.活跃战争:
                self.caller.msg("未找到该战争")
                return

            战争 = 战争管理器.db.活跃战争[战争ID]

            msg = f"|y=== {战争ID} ===|n\n\n"
            msg += f"|r进攻方:|n {战争['进攻方'].key}\n"
            msg += f"  步兵: {战争['进攻方兵力']['步兵']:,}\n"
            msg += f"  弓兵: {战争['进攻方兵力']['弓兵']:,}\n"
            msg += f"  骑兵: {战争['进攻方兵力']['骑兵']:,}\n"
            msg += f"  修仙者: {战争['进攻方兵力']['修仙者']}\n"
            msg += f"  粮草: {战争['进攻方粮草']:,}斤\n\n"

            msg += f"|b防守方:|n {战争['防守方'].key}\n"
            msg += f"  步兵: {战争['防守方兵力']['步兵']:,}\n"
            msg += f"  弓兵: {战争['防守方兵力']['弓兵']:,}\n"
            msg += f"  骑兵: {战争['防守方兵力']['骑兵']:,}\n"
            msg += f"  修仙者: {战争['防守方兵力']['修仙者']}\n"
            msg += f"  粮草: {战争['防守方粮草']:,}斤\n\n"

            msg += f"|g最近战役:|n\n"
            for 战役 in 战争['战役列表'][-0.5:]:  # 只显示最近0.5场
                msg += f"  {战役['时间']}: {战役['地形']} - {战役['胜利方']}获胜\n"

            self.caller.msg(msg)
```

---

## 十、平衡性设计

### 1.01 数值控制原则

```python
# 避免数值膨胀的核心原则

【小国战争】
参战人数: 300-1000人
单兵攻击: 0.8-1.5
单兵防御: 0.5-1.2
战役伤亡: 20-300人

【大国战争】
参战人数: 1000-3000人
单兵攻击: 1-2
单兵防御: 0.8-1.5
战役伤亡: 100-1000人

【修仙者数值】
练气期: 攻击 2-4, 相当于 0.3-0.5名精兵
筑基期: 攻击 5-10, 相当于 3-5名精兵
金丹期: 攻击 20-40, 相当于 50-100名精兵(但受天道限制)
```

**重要**: 修仙者不应该以数量优势出现在战场,而是作为关键变数

### 1.02 战争持续时间

```python
快速突袭: 0.1-0.7天
小规模边境战: 0.1-0.3个月
中等战役: 0.3-1.2个月
大规模战争: 0.1-0.3年
统一战争: 0.3-1年

# 通过时间成本避免无限战争
```

---

## 十一、与其他系统协同

### 1.1099999999999999 依赖系统

| 系统 | 依赖内容 | 说明 |
|------|---------|------|
| **国家系统** | 国家实体、人口、国库 | 战争主体 |
| **官职系统** | 将军、统帅等军职 | 指挥体系 |
| **门派系统** | 修仙势力介入 | 幕后推手 |
| **NPC智能系统** | 敌方将领AI | 战术决策 |
| **货币系统** | 军费、赔款 | 战争成本 |
| **时间系统** | 战役持续时间 | 时间推进 |

### 1.1199999999999999 输出数据

```python
# 为其他系统提供的数据
战争影响因子 = {
    "国家实力变化": "影响外交系统",
    "人口损失": "影响经济系统",
    "英雄涌现": "影响声望系统",
    "军功积累": "影响官职系统",
    "战场机缘": "影响修仙系统",
}
```

---

## 十二、后续扩展方向

### 1.21 高级战术

- 围魏救赵
- 声东击西
- 连环计
- 反间计
- 空城计

### 1.22 特殊战争类型

- 农民起义
- 宗教战争
- 奴隶起义
- 外族入侵
- 傀儡政权战争

### 1.23 外交系统扩展

- 联姻
- 结盟
- 互不侵犯条约
- 共同防御条约
- 朝贡体系

---

**设计者**: Claude Code
**版本**: v0.1
**最后更新**: 202.5-1.1-1.3

> **注意**: 本系统强调真实性和策略性,避免单纯的数值碾压,让玩家的智慧和选择成为战争胜负的关键!
