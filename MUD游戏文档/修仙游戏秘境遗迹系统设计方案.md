# 修仙游戏秘境/遗迹探索系统设计方案

> 基于主流修仙游戏（一念逍遥、想不想修真、觅长生、鬼谷八荒）和Roguelike玩法设计

>
> **重要**: 本文档定义秘境副本
>
> **依赖系统**: 境界系统、装备系统
>
> **参考标准**: 详见《【重要】文档统一标准.md》

---

## 一、系统概述

### 1.1 什么是秘境/遗迹？

秘境/遗迹是修仙世界中的**特殊副本地图**，通常是上古修士遗留的洞府、宗门遗址、试炼之地等。这些地方充满机遇与危险，是获取稀有资源的重要途径。

### 1.2 系统核心价值

- **资源产出**：稀有功法、法宝、丹药、灵药的主要来源
- **可重玩性**：随机生成的地图和奖励，提供持续游玩动力
- **探索乐趣**：解谜、寻宝、战斗的综合体验
- **风险收益**：高风险高回报，刺激玩家冒险
- **内容更新**：可以不断添加新秘境，延长游戏寿命

### 1.3 设计理念

**结合Roguelike元素**：
- 随机生成地图
- 永久死亡机制（可选）
- 资源管理
- 风险决策

**保留修仙特色**：
- 境界限制（只有达到特定境界才能进入）
- 机缘触发
- 法宝寻宝
- 阵法破解

---

## 二、秘境分类体系

### 2.1 按难度/境界分类

| 秘境类型 | 境界要求 | 难度 | 推荐人数 | 产出 | 示例 |
|---------|---------|------|---------|------|------|
| **试炼秘境** | 练气-筑基 | ★ | 1人 | 基础资源 | 新手试炼洞 |
| **普通秘境** | 筑基-金丹 | ★★ | 1-2人 | 普通法宝 | 散修洞府 |
| **高级秘境** | 金丹-元婴 | ★★★ | 2-3人 | 稀有功法 | 宗门遗址 |
| **危险秘境** | 元婴-化神 | ★★★★ | 3-5人 | 顶级法宝 | 上古战场 |
| **禁地秘境** | 化神+ | ★★★★★ | 5-10人 | 仙器传承 | 仙人洞府 |
| **特殊秘境** | 不限 | 变动 | 不限 | 特殊奖励 | 时空裂隙 |

### 2.2 按类型分类

#### 1. 洞府遗迹 🏠
```
特点：
  - 前辈修士的修炼场所
  - 有藏经阁、炼丹房、灵药园
  - 可能有主人留下的考验

奖励：
  - 功法秘籍
  - 丹药配方
  - 灵药种子
  - 炼丹炉等设施

危险：
  - 守护傀儡
  - 机关陷阱
  - 灵气枯竭区域

代表秘境：
  - 青云道人洞府
  - 炼丹宗师居所
  - 散仙静修地
```

#### 2. 宗门遗址 ⛩️
```
特点：
  - 曾经强大宗门的废墟
  - 规模宏大，建筑众多
  - 有大量战斗痕迹

奖励：
  - 宗门绝学
  - 护山大阵
  - 宗门宝库
  - 镇派法宝

危险：
  - 残余弟子怨灵
  - 失控的护山大阵
  - 强大的守护灵兽

代表秘境：
  - 天剑宗遗址
  - 万花谷废墟
  - 魔宗禁地
```

#### 3. 上古战场 ⚔️
```
特点：
  - 大战遗留的战场
  - 到处是法宝残骸
  - 充满杀气和怨念

奖励：
  - 破损法宝（可修复）
  - 战斗技巧
  - 杀阵图纸
  - 战场遗宝

危险：
  - 不死战魂
  - 残留的法术能量
  - 随机的空间裂缝

代表秘境：
  - 正魔大战遗址
  - 妖族战场
  - 神魔古战场
```

#### 4. 试炼之地 🎯
```
特点：
  - 专门用于考验修士
  - 有明确的关卡
  - 通关有奖励

奖励：
  - 试炼积分
  - 境界感悟
  - 特殊称号
  - 传承令牌

危险：
  - 强度递增的敌人
  - 时间限制
  - 失败惩罚

代表秘境：
  - 百层试炼塔
  - 九幽炼狱
  - 天道试炼场
```

#### 5. 秘境福地 🌄
```
特点：
  - 灵气浓郁的天然秘境
  - 有珍稀灵药生长
  - 灵兽聚集

奖励：
  - 天材地宝
  - 灵兽蛋
  - 灵泉
  - 灵矿

危险：
  - 强大的灵兽守护
  - 灵气暴动
  - 其他修士争夺

代表秘境：
  - 万药谷
  - 灵兽山
  - 五行秘境
```

#### 6. 时空裂隙 🌀
```
特点：
  - 随机出现的特殊秘境
  - 连接不同时空
  - 存在时间短暂

奖励：
  - 跨时空宝物
  - 未来/过去的物品
  - 特殊机缘

危险：
  - 时空乱流
  - 来自其他时空的敌人
  - 随时可能关闭

代表秘境：
  - 上古时空裂隙
  - 未来投影
  - 平行世界入口
```

### 2.3 按开放方式分类

#### 固定秘境
```
特点：
  - 位置固定，永久存在
  - 可以重复进入（有冷却时间）
  - 奖励固定但有刷新周期

示例：
  - 门派试炼塔
  - 国家秘境
  - 知名遗迹
```

#### 限时秘境
```
特点：
  - 定期开放（每周/每月）
  - 开放时间有限
  - 奖励丰厚

示例：
  - 月圆秘境（满月开启）
  - 雷劫秘境（雷雨天开启）
  - 节日秘境（特定节日）
```

#### 随机秘境
```
特点：
  - 随机刷新在世界地图上
  - 发现即可进入
  - 先到先得

示例：
  - 野外洞府
  - 突然出现的传送门
  - 机缘触发的秘境
```

#### 任务秘境
```
特点：
  - 通过任务线解锁
  - 一次性秘境
  - 剧情导向

示例：
  - 师父布置的试炼
  - 追寻仇人的老巢
  - 寻找宝物的遗迹
```

---

## 三、秘境结构设计

### 3.1 地图生成系统

#### 随机生成算法（Roguelike风格）

```gdscript
# 秘境地图生成器
class 秘境地图生成器:
	# 地图配置
	var 地图大小: Vector2i = Vector2i(20, 20)
	var 房间数量: int = 10
	var 房间大小范围: Vector2i = Vector2i(3, 7)

	# 房间类型
	enum 房间类型 {
		入口,
		普通,
		战斗,
		宝箱,
		商店,
		Boss,
		出口,
		机关,
		休息
	}

	func 生成地图() -> Dictionary:
		var 地图 = {}

		# 1. 生成房间
		var 房间列表 = 生成房间()

		# 2. 连接房间（生成走廊）
		var 走廊列表 = 连接房间(房间列表)

		# 3. 放置内容（敌人、宝箱、机关等）
		放置内容(房间列表)

		# 4. 生成事件点
		var 事件点 = 生成事件点(房间列表)

		地图["房间"] = 房间列表
		地图["走廊"] = 走廊列表
		地图["事件点"] = 事件点

		return 地图

	func 生成房间() -> Array:
		var 房间列表 = []

		# 生成入口房间
		房间列表.append(创建房间(房间类型.入口, Vector2i(0, 0)))

		# 生成普通房间
		for i in range(房间数量 - 3):
			var 类型 = 随机选择房间类型()
			var 位置 = 寻找合适位置(房间列表)
			房间列表.append(创建房间(类型, 位置))

		# 生成Boss房间
		房间列表.append(创建房间(房间类型.Boss, 寻找最远位置(房间列表)))

		# 生成出口房间
		房间列表.append(创建房间(房间类型.出口, 寻找最远位置(房间列表)))

		return 房间列表

	func 创建房间(类型: 房间类型, 位置: Vector2i) -> Dictionary:
		var 房间大小 = Vector2i(
			randi_range(房间大小范围.x, 房间大小范围.y),
			randi_range(房间大小范围.x, 房间大小范围.y)
		)

		return {
			"类型": 类型,
			"位置": 位置,
			"大小": 房间大小,
			"已清理": false,
			"内容": []
		}
```

#### 地图模板（预设地图）

```gdscript
# 预设地图模板
const 秘境模板 = {
	"青云洞府": {
		"主题": "炼丹",
		"布局": "线性",
		"房间": [
			{"类型": "入口", "描述": "洞府大门"},
			{"类型": "普通", "描述": "前院", "敌人": ["傀儡守卫×2"]},
			{"类型": "宝箱", "描述": "丹房", "宝物": ["丹方×1"]},
			{"类型": "战斗", "描述": "藏经阁", "敌人": ["护法傀儡"]},
			{"类型": "Boss", "描述": "主殿", "Boss": "青云道人残念"},
			{"类型": "出口", "描述": "后山传送阵"}
		]
	},

	"天剑宗遗址": {
		"主题": "剑修",
		"布局": "分支",
		"特殊机制": "剑阵",
		"房间数量": 15
	}
}
```

### 3.2 房间类型详解

#### 1. 入口房间
```
特点：
  - 安全区域，无敌人
  - 有秘境介绍石碑
  - 可以返回外界（有限制）

功能：
  - 查看秘境信息
  - 准备装备和丹药
  - 组队等待
```

#### 2. 战斗房间（60%）
```
特点：
  - 有一定数量的敌人
  - 清理后获得奖励
  - 可能有机关辅助战斗

敌人配置：
  - 小怪×3-5
  - 精英怪×1-2
  - 特殊怪×0-1（有几率）

奖励：
  - 经验值
  - 灵石
  - 普通装备/丹药
  - 秘境积分
```

#### 3. 宝箱房间（15%）
```
特点：
  - 有宝箱但需要解谜/战斗
  - 可能有陷阱
  - 奖励较好

宝箱类型：
  - 木箱（普通）
  - 银箱（稀有）
  - 金箱（史诗）
  - 仙箱（传说）

守护方式：
  - 机关锁（需要解谜）
  - 守护怪（需要战斗）
  - 阵法封印（需要破阵）
  - 无守护（运气好）
```

#### 4. 机关房间（10%）
```
特点：
  - 有各种机关陷阱
  - 需要技巧通过
  - 失败会受伤

机关类型：
  - 落石陷阱（闪避判定）
  - 火焰喷射（时机判定）
  - 毒气密室（速度挑战）
  - 移动平台（操作技巧）

破解方式：
  - 灵活闪避
  - 破坏机关
  - 找到控制机关
  - 使用特殊道具
```

#### 5. 休息房间（5%）
```
特点：
  - 安全区域
  - 可以恢复状态
  - 可能有NPC商人

功能：
  - 恢复气血/真元
  - 购买补给
  - 存档点（保存进度）
  - 整理背包
```

#### 6. 事件房间（5%）
```
特点：
  - 触发特殊事件
  - 需要做出选择
  - 选择影响后续

事件示例：
  - 遇到受伤修士（帮助/抢劫/无视）
  - 发现神秘石碑（参悟/破坏/离开）
  - 灵泉（饮用/装瓶/污染）
  - 传送阵（随机传送）
```

#### 7. 商店房间（3%）
```
特点：
  - 有NPC商人
  - 可以买卖物品
  - 价格较高

商品：
  - 丹药补给
  - 破阵符
  - 临时增益道具
  - 秘境专用道具
```

#### 8. Boss房间（1%）
```
特点：
  - 强大的守关Boss
  - 击败后获得丰厚奖励
  - 通常是秘境最后一关

Boss类型：
  - 洞府主人残念
  - 失控的护法傀儡
  - 变异灵兽
  - 堕落修士

奖励：
  - 稀有功法
  - 顶级法宝
  - 大量灵石
  - 秘境通关证明
```

#### 9. 出口房间（1%）
```
特点：
  - 完成秘境的出口
  - 结算奖励
  - 可以选择继续探索或离开

功能：
  - 查看探索度
  - 查看收获
  - 离开秘境
```

### 3.3 地图布局模式

```
线性布局（简单）：
入口 → 房间1 → 房间2 → 房间3 → Boss → 出口

分支布局（中等）：
		┌→ 房间2 ┐
入口 → 房间1 →      → Boss → 出口
		└→ 房间3 ┘

网状布局（复杂）：
入口 ┬→ 房间1 → 房间4 ┐
	 ├→ 房间2 → 房间5 ┼→ Boss → 出口
	 └→ 房间3 → 房间6 ┘

环形布局（迷宫）：
	 ┌→ 房间2 → 房间4 ┐
入口 → 房间1 → 房间3 → 房间5 → Boss → 出口
	 └←────────────┘
```

---

## 四、探索机制设计

### 4.1 迷雾系统（战争迷雾）

```gdscript
# 迷雾系统
class 迷雾系统:
	var 已探索区域: Array[Vector2i] = []
	var 可见范围: int = 3  # 玩家周围3格可见

	func 更新迷雾(玩家位置: Vector2i):
		# 清除周围迷雾
		for x in range(-可见范围, 可见范围 + 1):
			for y in range(-可见范围, 可见范围 + 1):
				var 位置 = 玩家位置 + Vector2i(x, y)
				if 位置 not in 已探索区域:
					已探索区域.append(位置)
					触发发现事件(位置)

	func 是否可见(位置: Vector2i) -> bool:
		return 位置 in 已探索区域

	func 获取探索度() -> float:
		return float(已探索区域.size()) / 总区域数 * 100
```

### 4.2 寻路与移动

```gdscript
# 秘境移动系统
class 秘境移动系统:
	var 当前房间: Dictionary
	var 可前往房间: Array = []

	func 获取可前往房间() -> Array:
		# 获取当前房间连接的房间
		return 当前房间.get("连接房间", [])

	func 移动到房间(目标房间: Dictionary):
		# 检查是否可以前往
		if 目标房间 not in 可前往房间:
			return false

		# 触发离开事件
		触发房间离开事件(当前房间)

		# 移动
		当前房间 = 目标房间

		# 触发进入事件
		触发房间进入事件(当前房间)

		return true

	func 触发房间进入事件(房间: Dictionary):
		match 房间.类型:
			房间类型.战斗:
				开始战斗(房间.敌人)
			房间类型.宝箱:
				显示宝箱(房间.宝箱)
			房间类型.机关:
				激活机关(房间.机关)
			房间类型.事件:
				触发事件(房间.事件)
```

### 4.3 探索进度系统

```gdscript
# 探索进度追踪
class 探索进度:
	var 房间总数: int = 0
	var 已探索房间: int = 0
	var 已击败敌人: int = 0
	var 已开启宝箱: int = 0
	var 已触发事件: int = 0
	var 探索时间: float = 0.0

	# 探索评分
	func 计算探索评分() -> String:
		var 探索率 = float(已探索房间) / 房间总数
		var 完成度 = (已击败敌人 + 已开启宝箱 + 已触发事件) / (房间总数 * 3.0)

		if 探索率 >= 0.95 and 完成度 >= 0.9:
			return "完美探索"  # SSS级奖励
		elif 探索率 >= 0.8 and 完成度 >= 0.7:
			return "优秀探索"  # SS级奖励
		elif 探索率 >= 0.6:
			return "良好探索"  # S级奖励
		elif 探索率 >= 0.4:
			return "普通探索"  # A级奖励
		else:
			return "匆忙探索"  # B级奖励
```

### 4.4 资源管理（生存要素）

```gdscript
# 秘境资源管理
class 秘境资源管理:
	var 剩余丹药: int = 10  # 携带的丹药数量
	var 剩余符箓: int = 5   # 携带的符箓数量
	var 负重: float = 0.0   # 当前负重
	var 负重上限: float = 100.0

	func 使用丹药() -> bool:
		if 剩余丹药 > 0:
			剩余丹药 -= 1
			return true
		return false

	func 拾取物品(物品: Dictionary) -> bool:
		var 物品重量 = 物品.get("重量", 1.0)

		if 负重 + 物品重量 <= 负重上限:
			负重 += 物品重量
			return true
		else:
			# 负重超载
			return false

	func 丢弃物品(物品: Dictionary):
		负重 -= 物品.get("重量", 1.0)
```

---

## 五、战斗与挑战

### 5.1 敌人配置

#### 敌人类型

```gdscript
# 秘境敌人配置
const 敌人模板 = {
	# 普通敌人（炮灰）
	"傀儡守卫": {
		"境界": "练气七层",
		"血量": 500,
		"攻击": 50,
		"防御": 30,
		"技能": ["基础攻击"],
		"掉落": {
			"灵石：10, 30],
			"装备": 0.1  # 10%掉落
		}
	},

	# 精英敌人（小Boss）
	"护法傀儡": {
		"境界": "筑基初期",
		"血量": 2000,
		"攻击": 120,
		"防御": 80,
		"技能": ["剑气斩", "护盾"],
		"特性": "格挡30%",
		"掉落": {
			"灵石：10, 100],
			"装备": 0.5,
			"丹药": 0.3
		}
	},

	# Boss（最终Boss）
	"青云道人残念": {
		"境界": "金丹后期",
		"血量": 10000,
		"攻击": 300,
		"防御": 150,
		"技能": ["剑阵", "天雷咒", "回春术"],
		"特性": "血量50%触发狂暴",
		"掉落": {
			"灵石：50, 1000],
			"功法": 1.0,  # 必掉
			"法宝": 0.8,
			"丹药": 1.0
		}
	}
}
```

#### 敌人强度调节

```gdscript
# 根据玩家境界调整敌人强度
func 调整敌人强度(敌人数据: Dictionary, 玩家境界: int) -> Dictionary:
	var 调整后 = 敌人数据.duplicate()

	# 境界差距系数
	var 境界差 = 玩家境界 - 敌人数据.境界等级
	var 调整系数 = 1.0 + 境界差 * 0.1

	调整后.血量 = int(敌人数据.血量 * 调整系数)
	调整后.攻击 = int(敌人数据.攻击 * 调整系数)
	调整后.防御 = int(敌人数据.防御 * 调整系数)

	return 调整后
```

### 5.2 机关陷阱

```gdscript
# 机关陷阱系统
const 机关类型 = {
	"落石陷阱": {
		"伤害": 200,
		"触发条件": "踩踏压力板",
		"破解方式": ["跳跃躲避", "破坏压力板"],
		"破解难度": "简单"
	},

	"火焰喷射": {
		"伤害": 500,
		"触发条件": "定时喷射",
		"破解方式": ["观察规律通过", "用水系法术熄灭"],
		"破解难度": "中等"
	},

	"剑阵": {
		"伤害": 1000,
		"触发条件": "进入房间",
		"破解方式": ["找到阵眼破坏", "硬扛通过"],
		"破解难度": "困难"
	},

	"毒气密室": {
		"伤害": "每秒50",
		"持续时间": 60,
		"破解方式": ["快速找到出口", "服用解毒丹"],
		"破解难度": "困难"
	}
}
```

### 5.3 谜题设计

#### 谜题类型

```
1. 阵法破解
   - 找到阵眼
   - 按照特定顺序激活
   - 需要阵法知识

2. 石碑解密
   - 古文翻译
   - 诗词谜语
   - 需要悟性

3. 机关解谜
   - 推箱子
   - 开关门
   - 需要智慧

4. 灵气引导
   - 引导灵气到特定位置
   - 类似管道游戏
   - 需要规划

5. 记忆考验
   - 记住特定顺序
   - 找出相同图案
   - 需要记忆力
```

#### 谜题示例：阵法破解

```gdscript
# 五行阵法解谜
class 五行阵法:
	var 阵眼位置 = ["金", "木", "水", "火", "土"]
	var 正确顺序 = ["木", "火", "土", "金", "水"]  # 五行相生
	var 当前顺序 = []

	func 激活阵眼(阵眼名: String):
		当前顺序.append(阵眼名)

		# 检查是否正确
		if 当前顺序.size() == 正确顺序.size():
			if 当前顺序 == 正确顺序:
				阵法破解成功()
			else:
				阵法破解失败()
				当前顺序.clear()

	func 阵法破解成功():
		print("阵法破解成功！秘门开启！")
		开启秘门()
		奖励玩家()

	func 阵法破解失败():
		print("阵法破解失败！受到反噬！")
		玩家受到伤害(500)
```

---

## 六、奖励与掉落系统

### 6.1 奖励分类

#### 固定奖励（通关奖励）
```gdscript
const 秘境通关奖励 = {
	"青云洞府": {
		"灵石：500,
		"经验：1000,
		"门派贡献": 100,
		"必得物品": ["青云心法（上卷）"],
		"称号": "青云传人"
	},

	"天剑宗遗址": {
		"灵石：2000,
		"经验：5000,
		"必得物品": ["天剑诀残篇", "宗门令牌"],
		"称号": "剑道传承者"
	}
}
```

#### 随机掉落（宝箱/敌人）
```gdscript
# 掉落池系统
class 掉落池:
	var 掉落表 = {
		"普通池": [
			{"物品": "灵石：10, 50], "概率": 50},
			{"物品": "疗伤丹", "数量": [1, 3], "概率": 30},
			{"物品": "普通装备", "概率": 15},
			{"物品": "符箓", "数量": [1, 2], "概率": 5}
		],

		"稀有池": [
			{"物品": "灵石：10, 500], "概率": 40},
			{"物品": "稀有丹药", "数量": [1, 2], "概率": 25},
			{"物品": "稀有装备", "概率": 20},
			{"物品": "功法残篇", "概率": 10},
			{"物品": "灵药种子", "概率": 5}
		],

		"史诗池": [
			{"物品": "灵石：100, 3000], "概率": 30},
			{"物品": "顶级丹药", "数量": [1, 2], "概率": 25},
			{"物品": "史诗装备", "概率": 20},
			{"物品": "完整功法", "概率": 15},
			{"物品": "天材地宝", "概率": 10}
		]
	}

	func 抽取奖励(池子名称: String, 次数: int = 1) -> Array:
		var 奖励列表 = []
		var 池子 = 掉落表[池子名称]

		for i in range(次数):
			var 随机值 = randf() * 100
			var 累计概率 = 0.0

			for 条目 in 池子:
				累计概率 += 条目.概率
				if 随机值 <= 累计概率:
					奖励列表.append(生成物品(条目))
					break

		return 奖励列表
```

### 6.2 宝箱系统

```gdscript
# 宝箱系统
class 宝箱:
	enum 宝箱品质 { 木箱, 银箱, 金箱, 仙箱 }

	var 品质: 宝箱品质
	var 是否已开启: bool = false
	var 守护方式: String = ""  # "无", "机关", "敌人", "阵法"

	# 宝箱配置
	const 宝箱配置 = {
		宝箱品质.木箱: {
			"掉落次数": 1,
			"掉落池": "普通池",
			"额外奖励概率": 0
		},
		宝箱品质.银箱: {
			"掉落次数": 2,
			"掉落池": "稀有池",
			"额外奖励概率": 0.2
		},
		宝箱品质.金箱: {
			"掉落次数": 3,
			"掉落池": "史诗池",
			"额外奖励概率": 0.5
		},
		宝箱品质.仙箱: {
			"掉落次数": 5,
			"掉落池": "史诗池",
			"额外奖励概率": 1.0,
			"保底传说": true
		}
	}

	func 开启宝箱() -> Array:
		if 是否已开启:
			return []

		# 检查是否通过守护
		if not 检查守护():
			return []

		是否已开启 = true

		# 生成奖励
		var 配置 = 宝箱配置[品质]
		var 奖励 = 掉落池.抽取奖励(配置.掉落池, 配置.掉落次数)

		# 额外奖励
		if randf() < 配置.额外奖励概率:
			奖励.append(生成额外奖励())

		# 保底机制
		if 配置.has("保底传说"):
			确保有传说物品(奖励)

		return 奖励
```

### 6.3 首通奖励

```gdscript
# 首次通关奖励
class 首通奖励系统:
	var 已通关秘境: Dictionary = {}

	func 检查首通(秘境ID: String) -> bool:
		return not 已通关秘境.has(秘境ID)

	func 发放首通奖励(秘境ID: String):
		if 检查首通(秘境ID):
			已通关秘境[秘境ID] = true

			# 额外奖励
			var 奖励 = {
				"灵石：1000,
				"经验：2000,
				"首通称号": "【%s·初探者】" % 秘境ID,
				"特殊奖励": 获取秘境特殊奖励(秘境ID)
			}

			发放奖励(奖励)
```

### 6.4 探索度奖励

```gdscript
# 根据探索完成度给予奖励
func 结算探索奖励(探索数据: 探索进度) -> Dictionary:
	var 评级 = 探索数据.计算探索评分()

	var 奖励倍率 = {
		"完美探索": 2.0,
		"优秀探索": 1.5,
		"良好探索": 1.2,
		"普通探索": 1.0,
		"匆忙探索": 0.7
	}

	var 倍率 = 奖励倍率[评级]

	return {
		"评级": 评级,
		"灵石": int(基础灵石 * 倍率),
		"经验": int(基础经验 * 倍率),
		"额外宝箱": 1 if 评级 == "完美探索" else 0
	}
```

---

## 七、特殊机制

### 7.1 秘境时间限制

```gdscript
# 时间限制系统
class 秘境时间限制:
	var 限制时间: float = 3600  # 秒（1小时）
	var 剩余时间: float = 限制时间
	var 警告阈值: float = 300  # 剩余5分钟警告

	func _process(delta: float):
		剩余时间 -= delta

		# 警告
		if 剩余时间 <= 警告阈值 and not 已警告:
			警告玩家("秘境即将关闭！")
			已警告 = true

		# 时间耗尽
		if 剩余时间 <= 0:
			强制离开秘境()

	func 强制离开秘境():
		print("秘境已关闭，被传送出秘境！")
		# 不结算奖励，直接传出
		传送出秘境(false)
```

### 7.2 死亡机制

```gdscript
# 秘境死亡处理
class 秘境死亡系统:
	enum 死亡模式 { 普通, 困难, 极限 }

	var 当前模式: 死亡模式 = 死亡模式.普通

	func 玩家死亡():
		match 当前模式:
			死亡模式.普通:
				# 原地复活，损失部分奖励
				原地复活()
				损失奖励(0.3)  # 损失30%

			死亡模式.困难:
				# 传送回入口，清空进度
				传送回入口()
				清空探索进度()

			死亡模式.极限:
				# 永久死亡（Roguelike）
				永久死亡()
				清空所有收获()
```

### 7.3 多人协作机制

```gdscript
# 多人秘境系统
class 多人秘境:
	var 最大人数: int = 5
	var 当前队伍: Array = []

	# 难度调整
	func 调整难度(玩家数: int):
		var 难度系数 = 1.0 + (玩家数 - 1) * 0.3

		# 敌人数量增加
		敌人数量 = int(基础敌人数量 * 难度系数)

		# 敌人血量增加
		敌人血量倍率 = 难度系数

		# 奖励增加
		奖励倍率 = 1.0 + (玩家数 - 1) * 0.2

	# 队伍分配奖励
	func 分配队伍奖励(总奖励: Array):
		var 平均分配 = []
		for 玩家 in 当前队伍:
			平均分配.append(总奖励.duplicate())

		return 平均分配
```

### 7.4 秘境事件系统

```gdscript
# 随机事件系统
const 秘境事件库 = {
	"遇到受伤修士": {
		"描述": "你遇到一位受伤的修士，他请求你的帮助...",
		"选项": [
			{
				"文本": "帮助他",
				"结果": "善业+10，获得感谢礼物",
				"奖励": {"丹药": 1, "善业": 10}
			},
			{
				"文本": "趁火打劫",
				"结果": "恶业+20，抢夺他的储物袋",
				"奖励": {"灵石：50, "恶业": 20}
			},
			{
				"文本": "无视离开",
				"结果": "无影响",
				"奖励": {}
			}
		]
	},

	"神秘石碑": {
		"描述": "你发现一块古老的石碑，上面刻着玄奥的文字...",
		"选项": [
			{
				"文本": "参悟石碑（需悟性80+）",
				"条件": {"悟性": 80},
				"结果": "领悟到技能感悟",
				"奖励": {"技能点": 1, "经验：500}
			},
			{
				"文本": "破坏石碑",
				"结果": "获得碎片，但失去感悟机会",
				"奖励": {"材料": "石碑碎片×5"}
			},
			{
				"文本": "拓印离开",
				"结果": "带走拓本，可以回去慢慢研究",
				"奖励": {"物品": "石碑拓本"}
			}
		]
	},

	"灵泉": {
		"描述": "你发现了一处清澈的灵泉，散发着浓郁的灵气...",
		"选项": [
			{
				"文本": "饮用灵泉",
				"结果": "恢复全部气血真元，临时增加属性",
				"效果": "恢复100%+临时加成10%属性（1小时）"
			},
			{
				"文本": "装瓶带走",
				"结果": "获得灵泉水×3",
				"奖励": {"物品": "灵泉水×3"}
			},
			{
				"文本": "投入毒药污染",
				"结果": "恶业+50，后续敌人全部中毒虚弱",
				"效果": "敌人弱化30%+恶业50"
			}
		]
	}
}
```

---

## 八、与现有系统协同

### 8.1 与机缘系统

```gdscript
# 秘境作为机缘的一种触发方式
class 秘境机缘整合:
	func 探索中触发机缘(玩家: 玩家数据):
		var 气运 = 玩家.属性管理器.基础属性.获取属性("气运")
		var 触发概率 = 气运 * 0.05  # 气运越高，概率越大

		if randf() * 100 < 触发概率:
			var 机缘类型 = [
				"发现隐藏密室",
				"遇到前辈残魂传承",
				"灵兽认主",
                "功法顿悟"
			].pick_random()

			触发机缘事件(机缘类型)
```

### 8.2 与门派系统

```gdscript
# 门派专属秘境
const 门派秘境 = {
	"天剑宗": {
		"秘境": "天剑宗遗址",
		"门派弟子加成": {
			"伤害": 1.2,
			"防御": 1.1,
			"掉落": 1.3
		},
		"专属奖励": ["天剑诀完整版"]
	},

	"万花谷": {
		"秘境": "万药谷",
		"门派弟子加成": {
			"采集速度": 2.0,
			"灵药品质": 1.5
		},
		"专属奖励": ["万花谷炼丹秘籍"]
	}
}
```

### 8.3 与装备系统

```gdscript
# 秘境专属装备
const 秘境装备 = {
	"探险者套装": {
		"2件套": "探索范围+50%",
		"4件套": "发现隐藏房间概率+30%",
		"6件套": "宝箱品质+1级"
	},

	"寻宝罗盘": {
		"类型": "饰品",
		"效果": "显示附近宝箱位置",
		"获取方式": "秘境Boss掉落"
	}
}
```

### 8.4 与炼丹/炼器系统

```gdscript
# 秘境产出材料
const 秘境材料 = {
	"上古灵木": {
		"产出秘境": ["宗门遗址", "上古战场"],
		"用途": "炼制仙器",
		"稀有度": "传说"
	},

	"天雷石": {
		"产出秘境": ["雷劫秘境"],
		"用途": "炼制雷属性装备",
		"稀有度": "史诗"
	},

	"九幽寒冰": {
		"产出秘境": ["极寒秘境"],
		"用途": "炼制冰系丹药",
		"稀有度": "稀有"
	}
}
```

---

## 九、UI界面设计

### 9.1 秘境选择界面

```
┌─────────────────────────────────────────────────┐
│              秘境/遗迹探索                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐│
│  │青云洞府    │  │天剑宗遗址  │  │上古战场    ││
│  │难度: ★★   │  │难度: ★★★★│  │难度: ★★★★★││
│  │境界: 筑基  │  │境界: 金丹  │  │境界: 元婴  ││
│  │冷却: 已就绪│  │冷却: 2小时 │  │冷却: 已就绪││
│  │[进入]      │  │[冷却中]    │  │[进入]      ││
│  └────────────┘  └────────────┘  └────────────┘│
│                                                 │
│  ┌────────────────────────────────────┐        │
│  │ 选中：青云洞府                      │        │
│  │                                    │        │
│  │ 类型：洞府遗迹                     │        │
│  │ 推荐人数：1-2人                    │        │
│  │ 预计时间：30-60分钟                │        │
│  │                                    │        │
│  │ 简介：                             │        │
│  │   青云道人的修炼洞府，内有丹房、    │        │
│  │   藏经阁等设施。守护傀儡实力不俗， │        │
│  │   需谨慎应对。                     │        │
│  │                                    │        │
│  │ 主要产出：                         │        │
│  │   • 青云心法                       │        │
│  │   • 炼丹配方                       │        │
│  │   • 灵药种子                       │        │
│  │                                    │        │
│  │ 首通奖励：额外获得称号【青云传人】 │        │
│  └────────────────────────────────────┘        │
│                                                 │
│  队伍设置：                                     │
│    ○ 单人探索  ● 组队探索（当前2/5人）        │
│                                                 │
│    [邀请好友]  [开始探索]  [返回]              │
└─────────────────────────────────────────────────┘
```

### 9.2 秘境探索界面

```
┌─────────────────────────────────────────────────┐
│  青云洞府                        [小地图]        │
├─────────────────────────────────────────────────┤
│                                                 │
│  状态栏：                                       │
│  气血: [▓▓▓▓▓▓▓░░░] 3500/5000                  │
│  真元: [▓▓▓▓░░░░░░] 1200/3000                  │
│  负重: 45/100  丹药: 7  符箓: 3                │
│                                                 │
│  ┌────────────────────────────────┐            │
│  │         当前房间：前院          │            │
│  │                                │            │
│  │    这里是洞府的前院，地面铺着  │            │
│  │    青色石板，两侧有两座石像。  │            │
│  │                                │            │
│  │    你发现了：                  │            │
│  │      • 傀儡守卫 ×2 [敌]        │            │
│  │      • 木制宝箱 ×1             │            │
│  │                                │            │
│  │    可前往：                    │            │
│  │      → 东：丹房                │            │
│  │      → 西：藏经阁              │            │
│  │      ← 南：洞府大门（入口）    │            │
│  └────────────────────────────────┘            │
│                                                 │
│  行动选项：                                     │
│    [攻击敌人]  [开启宝箱]  [前往下一个房间]    │
│    [使用丹药]  [查看地图]  [退出秘境]          │
│                                                 │
│  探索进度：                                     │
│    房间：3/10  宝箱：1/5  敌人：2/15           │
│    探索度：[▓▓░░░░░░░░] 25%                    │
│                                                 │
│  剩余时间：48:32                                │
└─────────────────────────────────────────────────┘
```

### 9.3 秘境小地图

```
┌─────────────────┐
│   秘境地图       │
├─────────────────┤
│                 │
│  ■ ─ ■ ─ ■     │
│  │   │   │     │
│  ■ ─ ● ─ ■     │
│      │         │
│      ■ ─ ？    │
│                 │
│ 图例：          │
│  ● 当前位置     │
│  ■ 已探索       │
│  ？ 未探索      │
│  ★ Boss房       │
│  ◆ 宝箱房       │
│  ▲ 商店房       │
└─────────────────┘
```

### 9.4 秘境结算界面

```
┌─────────────────────────────────────────────────┐
│            🎉 秘境探索完成！ 🎉                  │
├─────────────────────────────────────────────────┤
│                                                 │
│  秘境：青云洞府                                 │
│  用时：42分18秒                                 │
│                                                 │
│  ┌──────────────────────────────┐              │
│  │ 探索评价：优秀探索 (SS级)     │              │
│  │                              │              │
│  │  房间探索：9/10  (90%) ✓     │              │
│  │  敌人击败：14/15 (93%) ✓     │              │
│  │  宝箱开启：5/5  (100%) ✓     │              │
│  │  事件触发：3/3  (100%) ✓     │              │
│  └──────────────────────────────┘              │
│                                                 │
│  ┌──────────────────────────────┐              │
│  │ 获得奖励                      │              │
│  │                              │              │
│  │  基础奖励：                  │              │
│  │    • 灵石：10,500            │              │
│  │    • 经验：100,000          │              │
│  │    • 门派贡献 ×150           │              │
│  │                              │              │
│  │  战利品：                    │              │
│  │    • 青云心法（上卷）        │              │
│  │    • 筑基丹 ×3              │              │
│  │    • 稀有装备「青云护腕」    │              │
│  │    • 灵药种子 ×5            │              │
│  │                              │              │
│  │  首通奖励：                  │              │
│  │    • 称号：【青云传人】      │              │
│  │    • 灵石：10,000           │              │
│  │                              │              │
│  │  评级奖励（SS级）：          │              │
│  │    • 金宝箱 ×1              │              │
│  │    • 奖励倍率 ×1.5          │              │
│  └──────────────────────────────┘              │
│                                                 │
│       [查看详情]      [确认]                    │
└─────────────────────────────────────────────────┘
```

---

## 十、代码实现示例

### 10.1 秘境管理器

```gdscript
extends Node
class_name 秘境管理器

## 秘境/遗迹探索系统核心管理器

# 信号
signal 秘境进入(秘境ID: String)
signal 秘境退出(秘境ID: String, 奖励: Dictionary)
signal 房间进入(房间数据: Dictionary)
signal 房间清理完成(房间数据: Dictionary)
signal 宝箱发现(宝箱数据: Dictionary)
signal 事件触发(事件数据: Dictionary)

# 秘境配置数据库
const 秘境数据库 = preload("res://数据/秘境数据库.gd")

# 当前秘境状态
var 当前秘境: Dictionary = {}
var 当前地图: Dictionary = {}
var 探索进度: 探索进度
var 秘境时间: 秘境时间限制

# 秘境实例
var 地图生成器: 秘境地图生成器
var 掉落系统: 掉落池
var 事件系统: 秘境事件系统

func _ready():
	地图生成器 = 秘境地图生成器.new()
	掉落系统 = 掉落池.new()
	事件系统 = 秘境事件系统.new()

## 进入秘境
func 进入秘境(秘境ID: String, 玩家: 玩家数据, 队伍: Array = []) -> bool:
	# 获取秘境配置
	var 秘境配置 = 秘境数据库.获取秘境配置(秘境ID)
	if not 秘境配置:
		push_error("秘境不存在: " + 秘境ID)
		return false

	# 检查进入条件
	if not 检查进入条件(玩家, 秘境配置):
		return false

	# 初始化秘境
	当前秘境 = {
		"ID": 秘境ID,
		"配置": 秘境配置,
		"玩家": 玩家,
		"队伍": 队伍,
		"开始时间": Time.get_ticks_msec()
	}

	# 生成地图
	if 秘境配置.has("模板"):
		当前地图 = 加载预设地图(秘境配置.模板)
	else:
		当前地图 = 地图生成器.生成地图(秘境配置)

	# 初始化探索进度
	探索进度 = 探索进度.new()
	探索进度.房间总数 = 当前地图.房间.size()

	# 初始化时间限制
	if 秘境配置.has("时间限制"):
		秘境时间 = 秘境时间限制.new()
		秘境时间.限制时间 = 秘境配置.时间限制

	# 传送玩家到入口
	传送到入口房间()

	# 发送信号
	秘境进入.emit(秘境ID)

	return true

## 检查进入条件
func 检查进入条件(玩家: 玩家数据, 秘境配置: Dictionary) -> bool:
	# 检查境界要求
	if 秘境配置.has("境界要求"):
		var 玩家境界等级 = 玩家.属性管理器.境界系统.获取境界等级()
		if 玩家境界等级 < 秘境配置.境界要求:
			游戏管理器.显示消息.emit("境界不足，无法进入此秘境", "错误")
			return false

	# 检查冷却时间
	if 检查冷却中(秘境配置.ID):
		游戏管理器.显示消息.emit("秘境冷却中，请稍后再来", "提示")
		return false

	# 检查次数限制
	if 秘境配置.has("每日次数"):
		if 获取今日进入次数(秘境配置.ID) >= 秘境配置.每日次数:
			游戏管理器.显示消息.emit("今日进入次数已用完", "提示")
			return false

	return true

## 传送到入口房间
func 传送到入口房间():
	for 房间 in 当前地图.房间:
		if 房间.类型 == 地图生成器.房间类型.入口:
			进入房间(房间)
			break

## 进入房间
func 进入房间(房间: Dictionary):
	当前秘境.当前房间 = 房间

	# 标记为已探索
	if not 房间.已探索:
		房间.已探索 = true
		探索进度.已探索房间 += 1

	# 触发房间事件
	触发房间进入事件(房间)

	# 发送信号
	房间进入.emit(房间)

## 触发房间进入事件
func 触发房间进入事件(房间: Dictionary):
	match 房间.类型:
		地图生成器.房间类型.战斗:
			if not 房间.已清理:
				生成敌人(房间)

		地图生成器.房间类型.宝箱:
			if not 房间.已清理:
				生成宝箱(房间)

		地图生成器.房间类型.事件:
			if not 房间.已触发:
				触发随机事件(房间)

		地图生成器.房间类型.Boss:
			if not 房间.已清理:
				生成Boss(房间)

		地图生成器.房间类型.商店:
			显示商店(房间)

		地图生成器.房间类型.休息:
			提供休息选项(房间)

## 房间清理完成
func 房间清理完成(房间: Dictionary):
	房间.已清理 = true

	# 统计
	match 房间.类型:
		地图生成器.房间类型.战斗, 地图生成器.房间类型.Boss:
			探索进度.已击败敌人 += 房间.get("敌人数量", 0)

		地图生成器.房间类型.宝箱:
			探索进度.已开启宝箱 += 1

		地图生成器.房间类型.事件:
			探索进度.已触发事件 += 1

	# 发送信号
	房间清理完成.emit(房间)

## 开启宝箱
func 开启宝箱(宝箱: 宝箱) -> Array:
	if 宝箱.是否已开启:
		return []

	var 奖励 = 宝箱.开启宝箱()

	# 发送信号
	宝箱发现.emit({
		"品质": 宝箱.品质,
		"奖励": 奖励
	})

	return 奖励

## 触发随机事件
func 触发随机事件(房间: Dictionary):
	var 事件 = 事件系统.生成随机事件()
	房间.事件 = 事件
	房间.已触发 = true

	# 发送信号
	事件触发.emit(事件)

## 退出秘境
func 退出秘境(是否通关: bool = false):
	# 计算奖励
	var 奖励 = 结算奖励(是否通关)

	# 发放奖励
	发放奖励(奖励)

	# 记录冷却
	记录秘境冷却(当前秘境.ID)

	# 记录进入次数
	记录进入次数(当前秘境.ID)

	# 发送信号
	秘境退出.emit(当前秘境.ID, 奖励)

	# 清理数据
	当前秘境.clear()
	当前地图.clear()

## 结算奖励
func 结算奖励(是否通关: bool) -> Dictionary:
	var 奖励 = {}

	# 基础奖励
	if 是否通关:
		奖励 = 当前秘境.配置.通关奖励.duplicate()
	else:
		# 未通关按探索度给予部分奖励
		var 探索度 = 探索进度.计算探索度()
		奖励 = 计算部分奖励(探索度)

	# 探索评级奖励
	var 评级 = 探索进度.计算探索评分()
	var 评级奖励 = 计算评级奖励(评级)
	合并奖励(奖励, 评级奖励)

	# 首通奖励
	if 检查首通(当前秘境.ID):
		var 首通奖励 = 当前秘境.配置.首通奖励.duplicate()
		合并奖励(奖励, 首通奖励)
		标记已首通(当前秘境.ID)

	return 奖励

## 辅助函数

func 检查冷却中(秘境ID: String) -> bool:
	# TODO: 实现冷却检查
	return false

func 获取今日进入次数(秘境ID: String) -> int:
	# TODO: 实现次数统计
	return 0

func 记录秘境冷却(秘境ID: String):
	# TODO: 记录冷却时间
	pass

func 记录进入次数(秘境ID: String):
	# TODO: 记录进入次数
	pass

func 检查首通(秘境ID: String) -> bool:
	# TODO: 检查是否首通
	return true

func 标记已首通(秘境ID: String):
	# TODO: 标记首通
	pass

func 发放奖励(奖励: Dictionary):
	var 玩家 = 当前秘境.玩家

	# 灵石
	if 奖励.has("灵石"):
		玩家.灵石 += 奖励.灵石

	# 经验
	if 奖励.has("经验"):
		玩家.获得经验(奖励.经验)

	# 物品
	if 奖励.has("物品"):
		for 物品 in 奖励.物品:
			玩家.添加物品(物品)

func 计算部分奖励(探索度: float) -> Dictionary:
	var 基础奖励 = 当前秘境.配置.通关奖励.duplicate()
	var 系数 = 探索度 / 100.0

	return {
		"灵石：10) * 系数),
		"经验：100) * 系数)
	}

func 计算评级奖励(评级: String) -> Dictionary:
	var 倍率 = {
		"完美探索": 2.0,
		"优秀探索": 1.5,
		"良好探索": 1.2,
		"普通探索": 1.0,
		"匆忙探索": 0.7
	}

	return {
		"额外灵石：100 * 倍率[评级]),
		"额外经验：200 * 倍率[评级])
	}

func 合并奖励(奖励1: Dictionary, 奖励2: Dictionary):
	for key in 奖励2.keys():
		if 奖励1.has(key):
			if typeof(奖励1[key]) == TYPE_INT:
				奖励1[key] += 奖励2[key]
			elif typeof(奖励1[key]) == TYPE_ARRAY:
				奖励1[key].append_array(奖励2[key])
		else:
			奖励1[key] = 奖励2[key]

func 生成敌人(房间: Dictionary):
	# TODO: 实现敌人生成
	pass

func 生成宝箱(房间: Dictionary):
	# TODO: 实现宝箱生成
	pass

func 生成Boss(房间: Dictionary):
	# TODO: 实现Boss生成
	pass

func 显示商店(房间: Dictionary):
	# TODO: 实现商店界面
	pass

func 提供休息选项(房间: Dictionary):
	# TODO: 实现休息功能
	pass

func 加载预设地图(模板名: String) -> Dictionary:
	# TODO: 加载预设地图
	return {}
```

### 10.2 探索进度类

```gdscript
class_name 探索进度

var 房间总数: int = 0
var 已探索房间: int = 0
var 已击败敌人: int = 0
var 已开启宝箱: int = 0
var 已触发事件: int = 0
var 探索时间: float = 0.0

func 计算探索度() -> float:
	if 房间总数 == 0:
		return 0.0
	return float(已探索房间) / float(房间总数) * 100.0

func 计算探索评分() -> String:
	var 探索率 = 计算探索度() / 100.0
	var 内容完成度 = 0.0

	if 房间总数 > 0:
		内容完成度 = float(已击败敌人 + 已开启宝箱 + 已触发事件) / float(房间总数 * 3.0)

	if 探索率 >= 0.95 and 内容完成度 >= 0.9:
		return "完美探索"
	elif 探索率 >= 0.8 and 内容完成度 >= 0.7:
		return "优秀探索"
	elif 探索率 >= 0.6:
		return "良好探索"
	elif 探索率 >= 0.4:
		return "普通探索"
	else:
		return "匆忙探索"
```

---

## 十一、平衡性建议

### 11.1 难度曲线

```
境界要求    秘境难度    死亡惩罚    奖励价值
练气        ★          无          100
筑基        ★★        10%收益     500
金丹        ★★★      30%收益     2000
元婴        ★★★★    50%收益     8000
化神+       ★★★★★  全部收益    30000+
```

### 11.2 时间与奖励平衡

```
探索时长    建议奖励（灵石）  建议经验
15-30分     1000-3000        5000-10000
30-60分     3000-8000        10000-30000
60-120分    8000-20000       30000-80000
```

### 11.3 宝箱刷新率

```
房间类型    宝箱刷新概率
普通房间    15%
战斗房间    25%
Boss房间    100%
隐藏房间    80%
```

---

## 十二、后续扩展方向

### 12.1 赛季秘境

- 每个赛季推出限定秘境
- 赛季专属奖励
- 排行榜竞争

### 12.2 无尽模式

- 层数无限递增
- 难度不断提升
- 挑战极限

### 12.3 自定义秘境

- 玩家可以创建自己的秘境
- 设置难度和奖励
- 分享给其他玩家

### 12.4 秘境联盟

- 多个秘境组成剧情线
- 连续通关解锁终极奖励
- 跨秘境成就系统

---

## 十三、总结

秘境/遗迹系统是修仙游戏的**核心PVE内容**，设计要点：

### 关键设计原则

1. **可重玩性**：随机生成保证每次体验不同
2. **风险收益**：高风险高回报，刺激探索欲望
3. **策略深度**：资源管理、路线选择、风险判断
4. **即时反馈**：每个房间都有收获
5. **长期目标**：首通奖励、收集图鉴、挑战记录

### 实现优先级

#### MVP阶段（最小可玩版本）
- 预设地图模板（3-5个秘境）
- 基础房间类型（入口、战斗、宝箱、Boss、出口）
- 简单的战斗和宝箱系统
- 基础奖励结算

#### 第二阶段
- 随机地图生成
- 更多房间类型（机关、事件、商店）
- 时间限制和死亡机制
- 探索度评级系统

#### 第三阶段
- 多人协作模式
- 限时/赛季秘境
- 秘境成就系统
- 排行榜

---

**参考资料**：
- 《一念逍遥》- 秘境玩法参考
- 《想不想修真》- 洞府探索
- 《觅长生》- 遗迹系统
- 《杀戮尖塔》- Roguelike地图生成
- 《哈迪斯》- 房间设计和奖励机制
