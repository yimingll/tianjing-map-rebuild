# 修仙游戏境界突破/渡劫系统设计方案

> 基于主流修仙游戏（觅长生、了不起的修仙模拟器、想不想修真、一念逍遥）和经典修仙小说（凡人修仙传、仙逆、我欲封天、遮天）
>
> **重要**: 本文档定义境界突破规则
>
> **依赖系统**: 属性系统、丹药系统、装备系统
>
> **参考标准**: 详见《【重要】文档统一标准.md》第二章 - 境界系统统一标准

---

## 一、系统概述

### 1.1 什么是境界突破？

境界突破是修仙游戏的**核心玩法**，代表修士从一个境界晋升到下一个境界的关键过程。这是修仙游戏中最具仪式感和成就感的时刻。

### 1.2 系统核心价值

- **成就感塑造**：突破成功带来强烈的正反馈
- **风险与收益**：失败可能导致重伤甚至死亡
- **策略深度**：需要准备丹药、选择时机、提升属性
- **剧情推动**：每次大境界突破都是剧情节点
- **资源消耗**：是灵石、丹药等资源的重要消耗点

### 1.3 突破系统分类

#### 小境界突破（境界内层级提升）
- **示例**：练气一层 → 练气二层
- **难度**：低
- **失败惩罚**：受轻伤，修为倒退10%
- **突破方式**：积累修为到上限即可

#### 大境界突破（跨境界晋升）
- **示例**：练气九层 → 筑基期
- **难度**：高
- **失败惩罚**：重伤，修为倒退50%，可能跌落境界
- **突破方式**：需要通过心魔劫/天雷劫等考验

#### 特殊境界突破（关键节点）
- **示例**：元婴 → 化神，渡劫 → 大乘
- **难度**：极高
- **失败惩罚**：可能死亡，需要准备保命手段
- **突破方式**：天劫、心魔、劫数三重考验

---

## 二、境界体系设计

### 2.1 完整境界表

| 境界 | 层级 | 寿元 | 突破难度 | 天劫类型 | 参考小说 |
|------|------|------|---------|---------|---------|
| **练气期** | 1-13层 | 100年 | ★ | 无 | 《凡人修仙传》官方设定 |
| **筑基期** | 初/中/后期 | 200年 | ★★ | 无 | 《凡人修仙传》 |
| **金丹期** | 初/中/后期 | 500年 | ★★★ | 无 | 凝结金丹 |
| **元婴期** | 初/中/后期 | 1000年 | ★★★★ | 小天劫 | 元婴出窍 |
| **化神期** | 初/中/后期 | 2000年 | ★★★★ | 天劫 | 神识化形 |
| **炼虚期** | 初/中/后期 | 3000年 | ★★★★★ | 天劫 | 返虚合道 |
| **合体期** | 初/中/后期 | 5000年 | ★★★★★ | 大天劫 | 合体天地 |
| **大乘期** | 初/中/后期 | 8000年 | ★★★★★★ | 大天劫 | 准备飞升 |
| **渡劫期** | - | 10000年 | ★★★★★★★ | 飞升劫 | 最后考验 |

### 2.2 境界突破节点

```
练气1-13层 → 筑基（第一道坎，淘汰90%散修）
  ├─ 考验：冲开丹田，凝聚真元
  ├─ 失败率：70%（无丹药辅助）
  └─ 关键：筑基丹、悟性、灵根

筑基 → 金丹（凝丹，成败在此）
  ├─ 考验：凝结金丹，经历心魔
  ├─ 失败率：60%
  └─ 关键：凝丹诀、紫金丹、道心

金丹 → 元婴（化婴，脱胎换骨）
  ├─ 考验：金丹碎裂，元婴初成
  ├─ 失败率：50%
  └─ 关键：化婴丹、天劫准备

元婴 → 化神（第一次天劫）
  ├─ 考验：天雷劫（1-3道雷）
  ├─ 失败率：40%
  └─ 关键：法宝、阵法、化神丹

化神 → 炼虚（返虚合道）
  ├─ 考验：天劫（3-6道雷）
  ├─ 失败率：35%
  └─ 关键：顶级防御法宝、破劫丹

炼虚 → 合体（合体天地）
  ├─ 考验：大天劫（6-9道雷）
  ├─ 失败率：30%
  └─ 关键：渡劫经验、多重保命手段

合体 → 大乘（准仙人）
  ├─ 考验：灭世大劫
  ├─ 失败率：25%
  └─ 关键：气运、宿敌因果了结

大乘 → 飞升（飞升仙界）
  ├─ 考验：九九天劫（最强天劫）
  ├─ 失败率：20%
  └─ 关键：飞升丹、仙器、气运逆天
```

---

## 三、突破条件系统

### 3.1 基础条件（必须满足）

#### 1. 修为值达到上限
```
当前修为 >= 境界修为上限 × 100%
```

**示例**：
- 练气十三层修为上限：1300
- 玩家当前修为：1300 ✓

#### 2. 境界稳固度
```
境界稳固度 >= 80%
```

**稳固度影响因素**：
- 修炼速度过快：-10%（用丹药狂嗑会根基不稳）
- 战斗经验丰富：+10%
- 多次打坐：+5%
- 功法品质高：+10%

#### 3. 寿元充足
```
剩余寿元 > 突破所需时间
```

### 3.2 影响因素（影响成功率）

#### 属性影响（占40%）

| 属性 | 影响 | 权重 |
|------|------|------|
| **悟性** | 每点+0.5%成功率 | 25% |
| **气运** | 每点+0.3%成功率 | 15% |
| **体质** | 提高天劫抗性 | 10% |
| **道心** | 抗心魔能力 | 20% |
| **灵根** | 基础成功率 | 15% |

**示例计算**：
```
悟性：80点 → +40%成功率
气运：60点 → +18%成功率
道心：70点 → +14%成功率
基础成功率：50%
总成功率：50% + 40% + 18% + 14% = 122%（上限100%）
```

#### 丹药辅助（占30%）

| 丹药类型 | 效果 | 品质加成 |
|---------|------|---------|
| **筑基丹** | 练气→筑基，+30%成功率 | 下品+30%，中品+40%，上品+50% |
| **金丹辅助丹** | 筑基→金丹，+25%成功率 | 下品+25%，中品+35%，上品+45% |
| **化婴丹** | 金丹→元婴，+20%成功率 | 中品+30%，上品+40%，极品+50% |
| **化神丹** | 元婴→化神，+20%成功率 | 上品+30%，极品+40% |
| **破劫丹** | 渡天劫时抵御一道天雷 | - |
| **续命丹** | 失败时保命，防止死亡 | - |

#### 功法品质（占15%）

| 功法品质 | 成功率加成 | 说明 |
|---------|-----------|------|
| 凡阶 | +0% | 基础功法 |
| 灵阶 | +5% | 门派功法 |
| 玄阶 | +10% | 珍贵功法 |
| 地阶 | +15% | 顶级功法 |
| 天阶 | +20% | 仙界功法 |

#### 环境加成（占10%）

| 环境因素 | 加成 |
|---------|------|
| 在洞府灵脉上突破 | +5% |
| 聚灵阵加持 | +3% |
| 护法者（好友/师父） | +5% |
| 风水宝地 | +2% |
| 月圆之夜 | +3%（法修） |
| 雷雨天 | +3%（雷灵根） |

#### 负面影响（降低成功率）

| 负面因素 | 惩罚 |
|---------|------|
| 道心低于50 | -20% |
| 受伤状态 | -10% |
| 恶业过多 | -5%（天劫加强） |
| 根基不稳 | -15% |
| 寿元不足20年 | -10% |

### 3.3 成功率计算公式

```gdscript
# 基础成功率（根据境界）
var 基础成功率 = {
	"练气→筑基": 30,
	"筑基→金丹": 25,
	"金丹→元婴": 20,
	"元婴→化神": 15,
	"化神→炼虚": 12,
	"炼虚→合体": 10,
	"合体→大乘": 8,
	"大乘→飞升": 5
}

# 总成功率计算
func 计算突破成功率(玩家: 玩家数据, 丹药: Array, 环境: Dictionary) -> float:
	var 成功率 = 基础成功率[玩家.当前突破类型]

	# 属性加成
	成功率 += 玩家.悟性 * 0.5
	成功率 += 玩家.气运 * 0.3
	成功率 += (玩家.道心 - 50) * 0.2  # 道心50为基准

	# 灵根加成
	var 灵根系数 = 玩家.属性管理器.灵根系统.获取修炼速度()
	成功率 += 灵根系数 * 10

	# 丹药加成
	for 丹 in 丹药:
		成功率 += 丹.突破加成

	# 功法加成
	成功率 += 玩家.主修功法.突破加成

	# 环境加成
	if 环境.has("灵脉"):
		成功率 += 5
	if 环境.has("聚灵阵"):
		成功率 += 3
	if 环境.has("护法者"):
		成功率 += 5

	# 负面因素
	if 玩家.道心 < 50:
		成功率 -= 20
	if 玩家.受伤状态:
		成功率 -= 10
	if 玩家.境界稳固度 < 80:
		成功率 -= 15

	# 上下限
	成功率 = clamp(成功率, 5, 95)  # 最低5%，最高95%

	return 成功率
```

---

## 四、突破流程设计

### 4.1 突破准备阶段

#### 步骤1：检查突破条件
```
玩家点击"尝试突破"按钮
↓
系统检查：
  ✓ 修为是否已满
  ✓ 境界稳固度是否达标
  ✓ 寿元是否充足
  ✓ 是否有突破丹药
↓
显示突破信息面板：
  - 当前成功率
  - 建议准备的丹药
  - 最佳突破时机（月圆、雷雨等）
```

#### 步骤2：选择辅助道具
```
玩家可以选择：
  □ 突破丹药（筑基丹、化婴丹等）
  □ 防御法宝（天劫时使用）
  □ 保命丹药（续命丹、重生丹）
  □ 护法者（师父、道侣、好友）
```

#### 步骤3：选择突破地点
```
推荐地点：
  ⭐⭐⭐ 门派禁地（+10%，需要贡献度）
  ⭐⭐ 洞府灵脉（+5%）
  ⭐ 野外（无加成，但免费）
  ❌ 危险地带（可能被打断）
```

#### 步骤4：确认突破
```
显示最终信息：
  - 成功率：67%
  - 失败惩罚：修为-50%，重伤3天
  - 消耗：筑基丹×1，灵石×100
  - 时间：3小时

按钮：[确认突破] [返回准备]
```

### 4.2 突破过程阶段

#### 阶段1：冲击瓶颈（小境界）
```
播放动画：角色盘膝打坐，灵气汇聚
↓
进度条显示：
  [▓▓▓▓▓▓▓░░░] 70%
  "冲击练气九层瓶颈中..."
↓
随机事件可能触发：
  - 心魔干扰（需要道心判定）
  - 灵气暴走（需要控制力判定）
  - 突然顿悟（悟性判定，+5%成功率）
```

#### 阶段2：心魔劫（大境界）
```
进入心魔幻境：
  - 随机生成心魔场景
  - 玩家需要做出选择
  - 选择影响成功率

心魔场景示例：
  场景1：重见死去的亲友
	选项A：沉浸其中 → -10%成功率
	选项B：看破虚妄 → +5%成功率

  场景2：权力的诱惑
	选项A：接受 → 成为魔修，+恶业
	选项B：拒绝 → +道心

  场景3：仇人现身
	选项A：复仇 → +5%但+恶业
	选项B：放下 → +10%成功率
```

#### 阶段3：天劫降临（高境界）
```
天空乌云密布，雷声滚滚
↓
天劫倒计时：
  第1道天雷将在30秒后降下...

玩家可以：
  - 激活防御法宝
  - 使用破劫丹
  - 布置阵法
↓
天雷降下：
  伤害计算 = 天雷威力 - (玩家防御 + 法宝防御)

如果伤害 > 当前气血：
  使用续命丹 or 突破失败
```

#### 阶段4：稳固境界
```
突破成功后：
  新境界稳固度：60%（需要巩固修为）

建议：
  - 闭关7天稳固境界（稳固度→90%）
  - 或直接开始修炼（稳固度缓慢提升）
```

### 4.3 突破结果阶段

#### 成功结果
```
【境界突破成功！】

恭喜！你已成功晋升至【筑基期初期】！

属性提升：
  气血上限：500 → 1200 (+700)
  真元上限：300 → 800 (+500)
  物理攻击：50 → 80 (+30)
  法术攻击：60 → 100 (+40)

解锁内容：
  ✓ 神识外放（感知范围+50%）
  ✓ 御剑飞行（解锁飞行能力）
  ✓ 筑基期功法可修炼
  ✓ 寿元+100年

奖励：
  - 门派贡献度 +100
  - 声望 +50
  - 特殊称号：【新晋筑基】
```

#### 失败结果
```
【境界突破失败】

你未能突破境界，遭受反噬...

惩罚：
  ✗ 修为倒退50%（500/1000 → 250/1000）
  ✗ 境界稳固度-20%（80% → 60%）
  ✗ 进入重伤状态（3天内属性-50%）
  ✗ 道心-10

建议：
  - 服用疗伤丹药恢复
  - 闭关休养3-7天
  - 提升属性后再次尝试
```

#### 大失败结果（极低概率）
```
【走火入魔/身死道消】

突破过程中遭遇意外...

结果：
  ❌ 跌落一个大境界
  ❌ 修为清零
  ❌ 永久-10最大道心

或（如果没有续命丹）：
  ☠️ 角色死亡
  ☠️ 触发轮回/转世系统
```

---

## 五、天劫系统详解

### 5.1 天劫分类

#### 1-3道天雷（元婴→化神）
- **威力**：中等
- **间隔**：60秒
- **特点**：可以用法宝硬抗

#### 4-6道天雷（化神→炼虚）
- **威力**：高
- **间隔**：45秒
- **特点**：需要破劫丹+顶级法宝

#### 6-9道天雷（炼虚→合体）
- **威力**：极高
- **间隔**：30秒
- **特点**：后面的天雷会更强，需要阵法+法宝+丹药组合

#### 九九天劫（大乘→飞升）
- **威力**：毁天灭地
- **间隔**：15秒
- **特点**：81道天雷，最后九道为灭世紫雷

### 5.2 天雷伤害计算

```gdscript
func 计算天雷伤害(天劫等级: int, 第几道: int, 玩家: 玩家数据) -> int:
	# 基础伤害
	var 基础伤害 = 天劫等级 * 1000

	# 递增伤害（后面的天雷更强）
	var 递增系数 = 1.0 + (第几道 - 1) * 0.2

	# 恶业加成（恶业越多，天劫越强）
	var 恶业系数 = 1.0 + 玩家.恶业 * 0.01

	# 总伤害
	var 总伤害 = 基础伤害 * 递增系数 * 恶业系数

	# 防御计算
	var 防御 = 玩家.获取法术防御()
	var 法宝防御 = 玩家.装备的防御法宝.防御值 if 玩家.装备的防御法宝 else 0
	var 阵法防御 = 玩家.布置的阵法.防御值 if 玩家.布置的阵法 else 0

	var 总防御 = 防御 + 法宝防御 + 阵法防御

	# 最终伤害
	var 实际伤害 = max(总伤害 - 总防御, 总伤害 * 0.3)  # 至少造成30%伤害

	return int(实际伤害)
```

### 5.3 应对天劫策略

#### 策略1：防御流（堆防御）
```
装备：
  - 仙盾（防御+5000）
  - 金刚护体符（吸收10000伤害）
  - 玄武阵法（减伤30%）

丹药：
  - 金刚丹（临时+2000防御）

适合：体修、防御型玩家
```

#### 策略2：破劫流（消除天雷）
```
道具：
  - 破劫丹×3（直接抵消3道天雷）
  - 引雷针（将天雷引向他处）

适合：有钱玩家、高风险突破
```

#### 策略3：恢复流（边抗边恢复）
```
准备：
  - 疗伤丹药×10
  - 自动嗑药脚本
  - 高回复装备

适合：持久战型玩家
```

#### 策略4：阵法流（借助外力）
```
准备：
  - 门派大阵护持（需要求助掌门）
  - 天罡北斗阵（需要7位同门助阵）
  - 聚灵大阵（吸收天地灵气恢复）

适合：门派弟子
```

---

## 六、心魔系统设计

### 6.1 心魔类型

#### 1. 执念心魔
```
触发条件：有未完成的执念

表现形式：
  - 死去的亲人求助
  - 未报的深仇
  - 未了的情缘

考验：能否看破虚妄，放下执念

选择影响：
  - 执着于执念 → 失败
  - 暂时放下 → 成功，但心结仍在
  - 彻底看破 → 成功，道心+10
```

#### 2. 恐惧心魔
```
触发条件：道心<60

表现形式：
  - 最害怕的场景重现
  - 实力强大的敌人
  - 无法战胜的困境

考验：能否克服恐惧

选择影响：
  - 逃避 → 失败
  - 硬抗 → 成功，但道心-5
  - 直面恐惧 → 成功，道心+5
```

#### 3. 欲望心魔
```
触发条件：恶业>50

表现形式：
  - 权力的诱惑
  - 财富的诱惑
  - 美色的诱惑

考验：能否抵御诱惑

选择影响：
  - 接受 → 失败/成为魔修
  - 拒绝 → 成功
```

#### 4. 愧疚心魔
```
触发条件：曾经做过伤害他人的事

表现形式：
  - 被害者的质问
  - 良心的谴责

考验：如何面对过去

选择影响：
  - 逃避责任 → 失败
  - 承认错误 → 成功，恶业-10
  - 弥补过错 → 成功，善业+10
```

### 6.2 心魔对话示例

```
【心魔劫：执念】

场景：你看到了十年前被妖兽杀死的父亲...

父亲的亡魂："孩儿，为父死得好惨啊...那妖兽还在逍遥法外..."

选项：
  A. "父亲！我一定为您报仇！"
	 → 陷入执念，突破失败

  B. "父亲已逝，我会继承您的遗志，但不会被仇恨蒙蔽。"
	 → 看破虚妄，突破成功，道心+5

  C. "这是心魔！父亲不会这样说话！"
	 → 识破心魔，突破成功，道心+10

  D. "我会报仇，但现在不是时候。"
	 → 暂时压制，突破成功，但埋下心魔种子
```

---

## 七、与现有系统的协同

### 7.1 与属性系统

```gdscript
# 属性对突破的影响
class 突破系统:
	func 计算属性影响(玩家: 玩家数据) -> float:
		var 加成 = 0.0

		# 悟性影响（最重要）
		加成 += 玩家.属性管理器.基础属性.获取属性("悟性") * 0.5

		# 气运影响
		加成 += 玩家.属性管理器.基础属性.获取属性("气运") * 0.3

		# 体质影响（天劫抗性）
		加成 += 玩家.属性管理器.基础属性.获取属性("体质") * 0.2

		# 道心影响（心魔抗性）
		var 道心 = 玩家.属性管理器.特殊系统.获取道心()
		if 道心 >= 80:
			加成 += 20
		elif 道心 < 50:
			加成 -= 20

		return 加成
```

### 7.2 与炼丹系统

```gdscript
# 突破丹药配方
const 突破丹药配方 = {
	"筑基丹": {
		"材料": ["灵参×1", "紫金芝×2", "百年何首乌×1"],
		"品质": {
			"下品": {"成功率": 30, "加成": 30},
			"中品": {"成功率": 50, "加成": 40},
			"上品": {"成功率": 70, "加成": 50}
		},
		"炼制难度": "中"
	},

	"化婴丹": {
		"材料": ["千年灵芝×1", "龙血草×3", "化婴果×1"],
		"品质": {
			"中品": {"成功率": 40, "加成": 30},
			"上品": {"成功率": 60, "加成": 40},
			"极品": {"成功率": 80, "加成": 50}
		},
		"炼制难度": "高"
	},

	"破劫丹": {
		"材料": ["雷击木×5", "九天息壤×1", "避雷珠×1"],
		"效果": "直接抵消一道天雷",
		"炼制难度": "极高"
	}
}
```

### 7.3 与境界系统

```gdscript
# 境界系统扩展
class 境界系统:
	var 境界稳固度: float = 100.0  # 新增
	var 突破次数: int = 0  # 记录突破次数
	var 失败次数: int = 0  # 记录失败次数

	func 尝试突破() -> bool:
		# 检查条件
		if not 检查突破条件():
			return false

		# 计算成功率
		var 成功率 = 计算突破成功率()

		# 随机判定
		var 随机值 = randf() * 100

		if 随机值 <= 成功率:
			突破成功()
			return true
		else:
			突破失败()
			return false

	func 突破成功():
		境界等级 += 1
		境界稳固度 = 60.0  # 新境界需要巩固
		突破次数 += 1

		# 属性提升
		更新境界属性加成()

		# 触发事件
		游戏管理器.触发事件("境界突破成功", {
			"新境界": 获取境界名称(),
			"突破次数": 突破次数
		})

	func 突破失败():
		失败次数 += 1
		当前修为 *= 0.5  # 修为倒退50%
		境界稳固度 -= 20

		# 玩家进入重伤状态
		玩家.添加状态("重伤", 3)  # 3天

		# 触发事件
		游戏管理器.触发事件("境界突破失败", {
			"失败次数": 失败次数
		})
```

### 7.4 与门派系统

```gdscript
# 门派提供的突破支持
class 门派系统:
	func 申请门派突破支持(玩家: 玩家数据) -> Dictionary:
		var 支持 = {}

		# 根据贡献度提供帮助
		var 贡献度 = 玩家.门派贡献度

		if 贡献度 >= 1000:
			支持["掌门护法"] = true  # 掌门亲自护法，+10%
			支持["门派大阵"] = true  # 可以在门派大阵中突破，+5%
			支持["赠送丹药"] = "上品突破丹"
		elif 贡献度 >= 500:
			支持["长老护法"] = true  # +5%
			支持["赠送丹药"] = "中品突破丹"
		elif 贡献度 >= 100:
			支持["赠送丹药"] = "下品突破丹"

		return 支持
```

### 7.5 与机缘系统

```gdscript
# 突破触发的机缘
func 突破后检查机缘(玩家: 玩家数据):
	# 突破时有概率触发特殊机缘
	var 气运 = 玩家.属性管理器.基础属性.获取属性("气运")
	var 触发概率 = 气运 * 0.1

	if randf() * 100 < 触发概率:
		var 机缘类型 = 随机选择([
			"顿悟神通",
			"获得传承",
			"法宝认主",
            "灵兽来投"
		])

		触发特殊机缘(机缘类型)
```

---

## 八、UI界面设计

### 8.1 突破准备界面

```
┌─────────────────────────────────────────┐
│         境界突破 - 准备阶段              │
├─────────────────────────────────────────┤
│                                         │
│  当前境界：练气九层 → 目标境界：筑基初期  │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 突破条件检查                │         │
│  │  ✓ 修为已满 (10000/10000)   │         │
│  │  ✓ 境界稳固度 (85%)         │         │
│  │  ✓ 寿元充足 (剩余45年)      │         │
│  │  ⚠ 未使用突破丹药           │         │
│  └──────────────────────────┘         │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 当前成功率                  │         │
│  │  [▓▓▓▓▓▓▓░░░] 67%          │         │
│  │                            │         │
│  │  属性加成：+40% (悟性80)    │         │
│  │  丹药加成：+0%              │         │
│  │  环境加成：+5% (洞府灵脉)   │         │
│  │  负面影响：-8% (轻伤)       │         │
│  └──────────────────────────┘         │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 选择辅助道具                │         │
│  │  □ 筑基丹(下品) +30%        │         │
│  │  □ 筑基丹(中品) +40%        │         │
│  │  □ 筑基丹(上品) +50%  [拥有]│         │
│  │  □ 续命丹 (失败时保命)      │         │
│  │  □ 护法者(师父) +5%         │         │
│  └──────────────────────────┘         │
│                                         │
│  失败惩罚：                              │
│    - 修为倒退50%                        │
│    - 重伤状态3天                        │
│    - 道心-10                            │
│                                         │
│    [确认突破]    [返回]                 │
└─────────────────────────────────────────┘
```

### 8.2 突破过程界面

```
┌─────────────────────────────────────────┐
│           境界突破进行中                 │
├─────────────────────────────────────────┤
│                                         │
│        [角色打坐动画]                    │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 突破进度                    │         │
│  │  [▓▓▓▓▓▓▓▓░░] 75%          │         │
│  │  正在冲击筑基瓶颈...         │         │
│  └──────────────────────────┘         │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 心魔劫                      │         │
│  │                            │         │
│  │  场景：你看到了死去的父亲... │         │
│  │                            │         │
│  │  父亲："孩儿，为父死得好惨..."│         │
│  │                            │         │
│  │  你的选择：                 │         │
│  │  [A] 一定为您报仇！         │         │
│  │  [B] 继承遗志，不被蒙蔽      │         │
│  │  [C] 这是心魔！             │         │
│  └──────────────────────────┘         │
│                                         │
│  剩余时间：02:35                         │
│                                         │
└─────────────────────────────────────────┘
```

### 8.3 天劫界面

```
┌─────────────────────────────────────────┐
│              天劫降临                    │
├─────────────────────────────────────────┤
│                                         │
│      [乌云密布，天雷滚滚动画]            │
│                                         │
│  天劫进度：第 3/6 道天雷                 │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 你的状态                    │         │
│  │  气血：3500/5000 [▓▓▓▓▓░░]  │         │
│  │  真元：1200/3000 [▓▓░░░░░]  │         │
│  │  状态：轻伤                 │         │
│  └──────────────────────────┘         │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 下一道天雷倒计时             │         │
│  │     【 45秒 】              │         │
│  │                            │         │
│  │  预计伤害：2000-2500        │         │
│  └──────────────────────────┘         │
│                                         │
│  快捷操作：                              │
│    [使用破劫丹] [激活法宝] [服用丹药]    │
│                                         │
│  战斗日志：                              │
│    第2道天雷降下！造成1850点伤害！       │
│    你的玄武盾抵挡了500点伤害！           │
│    你服用了疗伤丹，恢复800气血！         │
│                                         │
└─────────────────────────────────────────┘
```

### 8.4 突破结果界面

```
┌─────────────────────────────────────────┐
│        🎉 境界突破成功！ 🎉              │
├─────────────────────────────────────────┤
│                                         │
│  恭喜！你已成功晋升至                    │
│         【筑基期 初期】                  │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 属性提升                    │         │
│  │  气血上限：500 → 1200 ↑700  │         │
│  │  真元上限：300 → 800  ↑500  │         │
│  │  物理攻击：50  → 80   ↑30   │         │
│  │  法术攻击：60  → 100  ↑40   │         │
│  │  寿元上限：100 → 200  ↑100年│         │
│  └──────────────────────────┘         │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 解锁内容                    │         │
│  │  ✓ 神识外放（感知+50%）     │         │
│  │  ✓ 御剑飞行                 │         │
│  │  ✓ 筑基期功法可修炼         │         │
│  │  ✓ 可进入筑基期秘境         │         │
│  └──────────────────────────┘         │
│                                         │
│  ┌──────────────────────────┐         │
│  │ 获得奖励                    │         │
│  │  • 门派贡献度 +100          │         │
│  │  • 声望 +50                │         │
│  │  • 称号：【新晋筑基】       │         │
│  │  • 灵石 +5000              │         │
│  └──────────────────────────┘         │
│                                         │
│  提示：新境界稳固度60%，建议闭关巩固     │
│                                         │
│             [继续]                      │
└─────────────────────────────────────────┘
```

---

## 九、代码实现示例

### 9.1 境界突破管理器

```gdscript
extends Node
class_name 境界突破管理器

## 境界突破/渡劫系统核心管理器

# 信号
signal 突破开始(境界名称: String)
signal 突破进度更新(进度: float)
signal 心魔事件(心魔数据: Dictionary)
signal 天劫降临(天劫数据: Dictionary)
signal 突破成功(新境界: String)
signal 突破失败(惩罚: Dictionary)

# 突破配置
const 突破配置 = {
	"练气→筑基": {
		"基础成功率": 30,
		"所需时间": 180,  # 秒
		"心魔难度": "低",
		"有天劫": false,
		"失败修为惩罚": 0.5,
		"失败道心惩罚": 10
	},
	"筑基→金丹": {
		"基础成功率": 25,
		"所需时间": 300,
		"心魔难度": "中",
		"有天劫": false,
		"失败修为惩罚": 0.5,
		"失败道心惩罚": 15
	},
	"金丹→元婴": {
		"基础成功率": 20,
		"所需时间": 600,
		"心魔难度": "中",
		"有天劫": true,
		"天劫道数": 3,
		"失败修为惩罚": 0.5,
		"失败道心惩罚": 20
	},
	"元婴→化神": {
		"基础成功率": 15,
		"所需时间": 900,
		"心魔难度": "高",
		"有天劫": true,
		"天劫道数": 6,
		"失败修为惩罚": 0.6,
		"失败道心惩罚": 25
	}
}

# 当前突破数据
var 当前突破: Dictionary = {}
var 正在突破: bool = false
var 突破计时器: Timer

func _ready():
	突破计时器 = Timer.new()
	add_child(突破计时器)
	突破计时器.timeout.connect(_on_突破阶段完成)

## 检查是否可以突破
func 检查突破条件(玩家: 玩家数据) -> Dictionary:
	var 结果 = {
		"可以突破": true,
		"原因": []
	}

	var 境界系统 = 玩家.属性管理器.境界系统

	# 检查修为
	if 境界系统.获取当前修为() < 境界系统.获取修为上限():
		结果.可以突破 = false
		结果.原因.append("修为未满")

	# 检查境界稳固度
	if 境界系统.境界稳固度 < 80:
		结果.可以突破 = false
		结果.原因.append("境界不稳固（需要80%以上）")

	# 检查寿元
	var 所需时间 = 获取突破所需时间(玩家)
	if 玩家.剩余寿元 < 所需时间 / 86400:  # 转换为天
		结果.可以突破 = false
		结果.原因.append("寿元不足")

	# 检查是否处于受伤状态
	if 玩家.has_状态("重伤"):
		结果.可以突破 = false
		结果.原因.append("当前处于重伤状态")

	return 结果

## 计算突破成功率
func 计算突破成功率(玩家: 玩家数据, 辅助道具: Array = [], 环境: Dictionary = {}) -> float:
	var 突破类型 = 获取突破类型(玩家)
	var 配置 = 突破配置.get(突破类型, {})

	# 基础成功率
	var 成功率: float = 配置.get("基础成功率", 50)

	# 属性加成
	var 属性系统 = 玩家.属性管理器.基础属性
	var 悟性 = 属性系统.获取属性("悟性")
	var 气运 = 属性系统.获取属性("气运")

	成功率 += 悟性 * 0.5
	成功率 += 气运 * 0.3

	# 道心影响
	var 道心 = 玩家.属性管理器.特殊系统.获取道心()
	成功率 += (道心 - 50) * 0.2

	# 灵根加成
	var 灵根系数 = 玩家.属性管理器.灵根系统.获取修炼速度()
	成功率 += 灵根系数 * 10

	# 功法加成
	if 玩家.主修功法:
		成功率 += 玩家.主修功法.突破加成

	# 丹药加成
	for 道具 in 辅助道具:
		if 道具.has("突破加成"):
			成功率 += 道具.突破加成

	# 环境加成
	if 环境.get("灵脉", false):
		成功率 += 5
	if 环境.get("聚灵阵", false):
		成功率 += 3
	if 环境.get("护法者", false):
		成功率 += 5

	# 境界稳固度加成
	var 境界系统 = 玩家.属性管理器.境界系统
	成功率 += (境界系统.境界稳固度 - 80) * 0.5

	# 负面影响
	if 道心 < 50:
		成功率 -= 20
	if 玩家.has_状态("受伤"):
		成功率 -= 10
	if 境界系统.境界稳固度 < 80:
		成功率 -= 15

	# 恶业影响
	var 特殊系统 = 玩家.属性管理器.特殊系统
	if 特殊系统.恶业 > 50:
		成功率 -= 特殊系统.恶业 * 0.1

	# 限制在5%-95%之间
	成功率 = clamp(成功率, 5, 95)

	return 成功率

## 开始突破
func 开始突破(玩家: 玩家数据, 辅助道具: Array = [], 环境: Dictionary = {}):
	if 正在突破:
		push_error("已经在突破中")
		return

	# 检查条件
	var 检查结果 = 检查突破条件(玩家)
	if not 检查结果.可以突破:
		push_error("不满足突破条件：" + str(检查结果.原因))
		return

	正在突破 = true

	# 初始化突破数据
	var 突破类型 = 获取突破类型(玩家)
	当前突破 = {
		"玩家": 玩家,
		"突破类型": 突破类型,
		"配置": 突破配置[突破类型],
		"辅助道具": 辅助道具,
		"环境": 环境,
		"成功率": 计算突破成功率(玩家, 辅助道具, 环境),
		"当前阶段": "冲击瓶颈",
		"阶段进度": 0.0,
		"心魔已过": false,
		"天劫已渡": false
	}

	# 发送信号
	突破开始.emit(突破类型)

	# 开始第一阶段
	开始冲击瓶颈阶段()

## 冲击瓶颈阶段
func 开始冲击瓶颈阶段():
	当前突破.当前阶段 = "冲击瓶颈"

	# 设置计时器
	var 所需时间 = 当前突破.配置.所需时间 * 0.3  # 30%时间用于冲击瓶颈
	突破计时器.start(所需时间)

	# 模拟进度
	var 进度计时器 = get_tree().create_timer(0.1)
	while 当前突破.当前阶段 == "冲击瓶颈":
		await 进度计时器.timeout
		当前突破.阶段进度 += 0.01
		突破进度更新.emit(当前突破.阶段进度 * 0.3)  # 总进度的30%
		进度计时器 = get_tree().create_timer(0.1)

func _on_突破阶段完成():
	match 当前突破.当前阶段:
		"冲击瓶颈":
			# 进入心魔劫阶段
			if 当前突破.配置.心魔难度 != "无":
				开始心魔劫阶段()
			else:
				# 直接判定成功
				判定突破结果()

		"心魔劫":
			# 进入天劫阶段
			if 当前突破.配置.有天劫:
				开始天劫阶段()
			else:
				# 直接判定成功
				判定突破结果()

		"天劫":
			# 判定最终结果
			判定突破结果()

## 心魔劫阶段
func 开始心魔劫阶段():
	当前突破.当前阶段 = "心魔劫"
	当前突破.阶段进度 = 0.0

	# 生成心魔场景
	var 心魔场景 = 生成心魔场景(当前突破.玩家)

	# 发送心魔事件
	心魔事件.emit(心魔场景)

## 处理心魔选择
func 处理心魔选择(选择: String):
	if 当前突破.当前阶段 != "心魔劫":
		return

	# 根据选择影响成功率
	var 影响 = 评估心魔选择(选择)
	当前突破.成功率 += 影响
	当前突破.心魔已过 = true

	# 继续下一阶段
	_on_突破阶段完成()

## 天劫阶段
func 开始天劫阶段():
	当前突破.当前阶段 = "天劫"
	当前突破.阶段进度 = 0.0

	var 天劫道数 = 当前突破.配置.天劫道数
	当前突破.天劫数据 = {
		"总道数": 天劫道数,
		"当前道数": 0,
		"玩家气血": 当前突破.玩家.生命值,
		"玩家最大气血": 当前突破.玩家.生命值上限
	}

	# 发送天劫事件
	天劫降临.emit(当前突破.天劫数据)

	# 开始第一道天雷
	降下天雷()

## 降下天雷
func 降下天雷():
	当前突破.天劫数据.当前道数 += 1
	var 当前道数 = 当前突破.天劫数据.当前道数

	# 计算伤害
	var 伤害 = 计算天雷伤害(当前道数)

	# 应用伤害
	当前突破.玩家.受到伤害(伤害)
	当前突破.天劫数据.玩家气血 = 当前突破.玩家.生命值

	# 检查是否死亡
	if 当前突破.玩家.生命值 <= 0:
		# 检查是否有续命丹
		if 使用续命丹():
			当前突破.玩家.生命值 = 当前突破.玩家.生命值上限 * 0.5
		else:
			# 突破失败，可能死亡
			突破失败(true)
			return

	# 检查是否所有天雷都已降下
	if 当前道数 >= 当前突破.天劫数据.总道数:
		当前突破.天劫已渡 = true
		_on_突破阶段完成()
	else:
		# 等待一段时间后降下下一道天雷
		await get_tree().create_timer(5.0).timeout
		降下天雷()

## 判定突破结果
func 判定突破结果():
	var 随机值 = randf() * 100

	if 随机值 <= 当前突破.成功率:
		突破成功()
	else:
		突破失败(false)

## 突破成功
func 突破成功():
	var 玩家 = 当前突破.玩家
	var 境界系统 = 玩家.属性管理器.境界系统

	# 提升境界
	境界系统.提升境界()

	# 新境界稳固度设为60%
	境界系统.境界稳固度 = 60.0

	# 奖励
	玩家.门派贡献度 += 100
	玩家.声望 += 50
	玩家.灵石 += 5000

	# 检查是否触发机缘
	检查突破机缘(玩家)

	# 发送信号
	突破成功.emit(境界系统.获取境界名称())

	# 重置状态
	正在突破 = false
	当前突破.clear()

## 突破失败
func 突破失败(死亡: bool = false):
	var 玩家 = 当前突破.玩家
	var 境界系统 = 玩家.属性管理器.境界系统
	var 配置 = 当前突破.配置

	if 死亡:
		# 角色死亡
		玩家.死亡()
	else:
		# 修为倒退
		var 当前修为 = 境界系统.获取当前修为()
		境界系统.设置当前修为(当前修为 * 配置.失败修为惩罚)

		# 境界稳固度下降
		境界系统.境界稳固度 -= 20

		# 道心下降
		玩家.属性管理器.特殊系统.道心 -= 配置.失败道心惩罚

		# 添加重伤状态
		玩家.添加状态("重伤", 3)

	# 发送信号
	var 惩罚 = {
		"死亡": 死亡,
		"修为惩罚": 配置.失败修为惩罚,
		"道心惩罚": 配置.失败道心惩罚
	}
	突破失败.emit(惩罚)

	# 重置状态
	正在突破 = false
	当前突破.clear()

## 辅助函数

func 获取突破类型(玩家: 玩家数据) -> String:
	var 当前境界 = 玩家.属性管理器.境界系统.获取境界名称()
	# 简化示例
	return "练气→筑基"

func 获取突破所需时间(玩家: 玩家数据) -> int:
	var 突破类型 = 获取突破类型(玩家)
	return 突破配置[突破类型].所需时间

func 生成心魔场景(玩家: 玩家数据) -> Dictionary:
	# 随机生成心魔场景
	var 心魔类型 = ["执念", "恐惧", "欲望", "愧疚"].pick_random()
	return {
		"类型": 心魔类型,
		"描述": "心魔场景描述...",
		"选项": [
			{"文本": "选项A", "影响": -10},
			{"文本": "选项B", "影响": 5},
			{"文本": "选项C", "影响": 10}
		]
	}

func 评估心魔选择(选择: String) -> float:
	# 评估心魔选择对成功率的影响
	return 5.0

func 计算天雷伤害(道数: int) -> int:
	var 配置 = 当前突破.配置
	var 基础伤害 = 1000 * 道数
	var 递增系数 = 1.0 + (道数 - 1) * 0.2

	# 恶业加成
	var 恶业 = 当前突破.玩家.属性管理器.特殊系统.恶业
	var 恶业系数 = 1.0 + 恶业 * 0.01

	return int(基础伤害 * 递增系数 * 恶业系数)

func 使用续命丹() -> bool:
	# 检查是否有续命丹
	for 道具 in 当前突破.辅助道具:
		if 道具.类型 == "续命丹":
			return true
	return false

func 检查突破机缘(玩家: 玩家数据):
	# 突破成功后可能触发机缘
	var 气运 = 玩家.属性管理器.基础属性.获取属性("气运")
	if randf() * 100 < 气运 * 0.1:
		# 触发机缘
		pass
```

---

## 十、平衡性建议

### 10.1 成功率平衡

```
练气→筑基：50-70%（不要太难，新手友好）
筑基→金丹：40-60%（中等难度）
金丹→元婴：30-50%（开始有挑战）
元婴→化神：20-40%（需要认真准备）
化神以上：10-30%（极高难度，需要大量准备）
```

### 10.2 丹药价值平衡

```
下品筑基丹：+30%成功率，售价5000灵石
中品筑基丹：+40%成功率，售价15000灵石
上品筑基丹：+50%成功率，售价50000灵石

性价比：下品 > 中品 > 上品
策略：前期用下品，后期冲上品
```

### 10.3 失败惩罚平衡

```
小境界失败：修为-20%，轻伤1天
大境界失败：修为-50%，重伤3天，道心-10
特殊境界失败：修为-70%，重伤7天，道心-20，可能跌境界

建议：失败不要过于严厉，否则玩家不敢尝试
```

---

## 十一、后续扩展方向

### 11.1 特殊突破方式

- **雷劫淬体**：主动引雷劫，增强体质
- **借劫突破**：帮助他人渡劫，自己也能获得好处
- **逆天改命**：消耗气运强行突破
- **夺舍重生**：失败后夺舍他人身体

### 11.2 突破相关玩法

- **渡劫排行榜**：记录最快/最难/最惊险的突破
- **突破录像**：可以回放自己的突破过程
- **突破见证**：观看他人渡劫，学习经验
- **共同渡劫**：多人同时突破，互相帮助

### 11.3 成就系统

- 【初出茅庐】：首次突破成功
- 【一帆风顺】：连续3次突破成功
- 【劫后余生】：在气血仅剩1%时成功渡劫
- 【逆天改命】：在成功率低于10%时成功突破

---

## 十二、总结

境界突破/渡劫系统是修仙游戏的**核心玩法**，设计时需要注意：

### 关键设计原则

1. **成就感**：突破成功要有强烈的正反馈
2. **风险收益**：失败要有代价，但不能过于严厉
3. **策略深度**：给玩家足够的准备空间
4. **多样性**：不同境界的突破要有差异化体验
5. **公平性**：氪金可以降低难度，但不能保证成功

### 实现优先级

#### 第一阶段（MVP）
- 基础突破流程
- 成功率计算
- 简单的失败惩罚

#### 第二阶段
- 心魔劫系统
- 丹药辅助
- UI界面

#### 第三阶段
- 天劫系统
- 特殊突破方式
- 成就系统

---

**参考资料**：
- 《觅长生》- 最完善的渡劫系统
- 《了不起的修仙模拟器》- 心魔系统设计
- 《凡人修仙传》小说 - 经典突破描写
- 《一念逍遥》- 数值平衡参考
