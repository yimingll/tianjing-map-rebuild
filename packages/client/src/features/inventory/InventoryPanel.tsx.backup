/**
 * èƒŒåŒ…é¢æ¿ç»„ä»¶
 * æ”¯æŒç‰©å“ç­›é€‰ã€æ‹–æ‹½æ¥æ”¶è£…å¤‡å¸ä¸‹
 */

import React, { useState } from 'react'
import { useDrop } from 'react-dnd'
import { useInventoryStore } from './inventoryStore'
import { useEquipmentStore } from '@/features/equipment/equipmentStore'
import { InventoryItem } from './InventoryItem'
import { SlotType } from '@/types/equipment'
import { gameClient } from '@/lib/gameClient'
import './InventoryPanel.css'

interface InventoryPanelProps {
  isOpen?: boolean
  onClose?: () => void
}

export const InventoryPanel: React.FC<InventoryPanelProps> = ({ onClose }) => {
  const [filter, setFilter] = useState<'all' | 'equipment' | 'consumable' | 'material'>('all')
  const [searchText, setSearchText] = useState('')
  const { items, capacity, getTotalWeight } = useInventoryStore()
  const { unequipItem } = useEquipmentStore()

  // æ¥æ”¶å¸ä¸‹çš„è£…å¤‡
  const [{ isOver }, drop] = useDrop({
    accept: 'EQUIPPED_ITEM',
    drop: (item: { slot_type: SlotType }) => {
      unequipItem(item.slot_type)
    },
    collect: (monitor) => ({
      isOver: monitor.isOver(),
    }),
  })

  const filteredItems = items.filter((item) => {
    // ç±»å‹ç­›é€‰
    const matchesType = filter === 'all' || item.item_type === filter

    // æœç´¢ç­›é€‰
    const matchesSearch = searchText === '' ||
      item.item_name.toLowerCase().includes(searchText.toLowerCase()) ||
      (item.description && item.description.toLowerCase().includes(searchText.toLowerCase()))

    return matchesType && matchesSearch
  })

  const handleUse = (instanceId: number) => {
    const item = items.find((i) => i.instance_id === instanceId)
    if (item) {
      gameClient.å‘é€å‘½ä»¤(`use ${item.item_name}`)
    }
  }

  const handleDrop = (instanceId: number) => {
    const item = items.find((i) => i.instance_id === instanceId)
    if (item) {
      if (window.confirm(`ç¡®å®šè¦ä¸¢å¼ƒ ${item.item_name} å—?`)) {
        gameClient.å‘é€å‘½ä»¤(`drop ${item.item_name}`)
      }
    }
  }

  return (
    <div ref={drop} className={`inventory-panel ${isOver ? 'drag-over' : ''}`}>
      <div className="inventory-header">
        <h2 className="panel-title">å‚¨ç‰©è¢‹</h2>
        <button
          className="close-btn"
          onClick={onClose}
          aria-label="å…³é—­èƒŒåŒ…"
        >
          Ã—
        </button>

        <div className="inventory-stats">
          <span className="stat-item">
            <span className="stat-label">ç‰©å“:</span>
            <span className="stat-value">{items.length} / {capacity}</span>
          </span>
          <span className="stat-divider">|</span>
          <span className="stat-item">
            <span className="stat-label">è´Ÿé‡:</span>
            <span className="stat-value">{getTotalWeight()}</span>
          </span>
        </div>

        {/* æœç´¢æ¡† */}
        <div className="search-container">
          <input
            type="text"
            className="search-input"
            placeholder="æœç´¢ç‰©å“åç§°æˆ–æè¿°..."
            value={searchText}
            onChange={(e) => setSearchText(e.target.value)}
          />
          {searchText && (
            <button
              className="clear-search-btn"
              onClick={() => setSearchText('')}
              aria-label="æ¸…ç©ºæœç´¢"
            >
              Ã—
            </button>
          )}
        </div>

        <div className="filter-buttons">
          <button
            className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
            onClick={() => setFilter('all')}
          >
            å…¨éƒ¨
          </button>
          <button
            className={`filter-btn ${filter === 'equipment' ? 'active' : ''}`}
            onClick={() => setFilter('equipment')}
          >
            è£…å¤‡
          </button>
          <button
            className={`filter-btn ${filter === 'consumable' ? 'active' : ''}`}
            onClick={() => setFilter('consumable')}
          >
            æ¶ˆè€—å“
          </button>
          <button
            className={`filter-btn ${filter === 'material' ? 'active' : ''}`}
            onClick={() => setFilter('material')}
          >
            ææ–™
          </button>
        </div>
      </div>

      <div className="inventory-grid">
        {filteredItems.map((item) => (
          <InventoryItem
            key={item.instance_id}
            item={item}
            onUse={handleUse}
            onDrop={handleDrop}
          />
        ))}

        {/* ç©ºæ§½ä½æç¤º */}
        {filteredItems.length === 0 && (
          <div className="empty-inventory">
            <div className="empty-icon">ğŸ’¼</div>
            <div className="empty-text">æš‚æ— ç‰©å“</div>
          </div>
        )}
      </div>

      {isOver && (
        <div className="drop-overlay">
          <div className="drop-hint">æ¾å¼€ä»¥å¸ä¸‹è£…å¤‡</div>
        </div>
      )}
    </div>
  )
}
